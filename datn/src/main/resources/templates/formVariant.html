<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Th√™m phi√™n b·∫£n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        form {
            margin-top: 20px;
            max-width: 600px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="file"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .edit-btn {
            background-color: #2980b9;
            color: white;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .save-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .product-image {
            height: 50px;
            display: block;
            margin: 0 auto;
        }
        
        .discounted-price {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .original-price {
            color: #95a5a6;
            text-decoration: line-through;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
  <div th:replace="~{dashboard :: nav}"></div>

  <h2>üß© Th√™m / C·∫≠p nh·∫≠t phi√™n b·∫£n s·∫£n ph·∫©m</h2>
  <form th:action="@{/variants/add}" method="post" th:object="${variant}" enctype="multipart/form-data">
    <input type="hidden" th:field="*{variantID}" />
    
    <div class="form-group">
      <label>S·∫£n ph·∫©m:</label>
      <select th:field="*{product.productID}" required>
        <option value="" disabled selected>-- Ch·ªçn s·∫£n ph·∫©m --</option>
        <option th:each="p : ${products}" 
                th:value="${p.productID}" 
                th:text="${p.productName}"></option>
      </select>
    </div>
    
    <div class="form-group">
      <label>M√†u:</label>
      <input type="text" th:field="*{color}" required />
    </div>
    
    <div class="form-group">
      <label>Dung l∆∞·ª£ng:</label>
      <select th:field="*{storage}" >
        <option value=""  selected>-- Ch·ªçn dung l∆∞·ª£ng --</option>
        <option value="128GB">128GB</option>
        <option value="256GB">256GB</option>
        <option value="512GB">512GB</option>
        <option value="1TB">1TB</option>
        <option value="2TB">2TB</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>S·ªë l∆∞·ª£ng:</label>
      <input type="number" th:field="*{quantityInStock}" required min="0" />
    </div>
    
    <div class="form-group">
      <label>Gi√° g·ªëc (VNƒê):</label>
      <input type="text" id="priceInput" th:value="${variant.price != null ? #numbers.formatDecimal(variant.price, 0, 'COMMA', 0, 'POINT') : ''}" />
      <input type="hidden" th:field="*{price}" id="priceHidden" />
    </div>
    
    <div class="form-group">
      <label>H√¨nh ·∫£nh:</label>
      <input type="file" name="imageFile" accept="image/*" />
      <span th:if="${variant.imagesno2 != null}">
        <img th:src="@{'/images/' + ${variant.imagesno2}}" class="product-image" style="max-height: 100px; margin-top: 10px;"/>
      </span>
    </div>
    
    <button type="submit" class="save-btn">L∆∞u phi√™n b·∫£n</button>
  </form>


  <form th:action="@{/admin/discount/apply}" method="post" class="space-y-4">
    <label for="">Gi·∫£m gi√° s·∫£n ph·∫©m</label><br>

    <!-- Ch·ªçn s·∫£n ph·∫©m -->
    <select name="productId" id="productSelect" required>
      <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
      <option th:each="p : ${products}" th:value="${p.productID}" th:text="${p.productName}"
        th:attr="data-storages=${p.storages}">
      </option>
    </select>

    <!-- Ch·ªçn dung l∆∞·ª£ng (l·ªçc theo s·∫£n ph·∫©m) -->
    <select name="storage" id="storageSelect" >
      <option value="">-- Ch·ªçn dung l∆∞·ª£ng --</option>
    </select>

    <!-- Nh·∫≠p ph·∫ßn trƒÉm gi·∫£m gi√° -->
    <input type="number" name="discount" placeholder="Ph·∫ßn trƒÉm gi·∫£m (vd: 10)" min="0" max="100" required />

    <!-- Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c -->
    <input type="date" name="startDate" min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required />
    <input type="date" name="endDate" min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required />

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">
      √Åp d·ª•ng gi·∫£m gi√°
    </button>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói -->
    <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4">
      <p th:text="${error}"></p>
    </div>

    <!-- Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng -->
    <div th:if="${success}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded mb-4">
      <p th:text="${success}"></p>
    </div>
  </form>


  <h3>üìã Danh s√°ch phi√™n b·∫£n</h3>
  <table>
    <thead>
      <tr>
        <th>STT</th>
        <th>S·∫£n ph·∫©m</th>
        <th>H√¨nh ·∫£nh</th>
        <th>M√†u</th>
        <th>Dung l∆∞·ª£ng</th>
        <th>Gi√°</th>
        <th>S·ªë l∆∞·ª£ng</th>
        <th>Gi·∫£m gi√°</th>
        <th>B·∫Øt ƒë·∫ßu</th>
        <th>K·∫øt th√∫c</th>
        <th>Thao t√°c</th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="v, stat : ${variants}">
        <td th:text="${stat.index + 1}"></td>
        <td th:text="${v.product.productName}"></td>

        <td>
          <img th:src="@{'/images/' + ${v.imagesno2}}" alt="·∫£nh" style="height: 50px" />
        </td>

        <td th:text="${v.color}"></td>
        <td th:text="${v.storage}"></td>

        <!-- Gi√° hi·ªÉn th·ªã: c√≥ gi·∫£m th√¨ hi·ªán 2 d√≤ng, kh√¥ng gi·∫£m th√¨ 1 d√≤ng -->
        <td>
          <span th:if="${v.discountedPrice < v.price}">
            <!-- Gi√° ƒë√£ gi·∫£m: n·ªïi b·∫≠t -->
            <span style="color: #dc2626; font-weight: bold; font-size: 1.125rem;"
              th:text="${#numbers.formatDecimal(v.discountedPrice, 0, 0) + ' VNƒê'}">
            </span>
            <br />
            <!-- Gi√° g·ªëc: m·ªù h∆°n, nh·ªè h∆°n -->
            <span style="color: #9ca3af; text-decoration: line-through; font-size: 0.75rem; font-style: italic;"
              th:text="${#numbers.formatDecimal(v.price, 0, 0) + ' VNƒê'}">
            </span>
          </span>



          <span th:if="${v.discountedPrice == v.price}">
            <span th:text="${#numbers.formatDecimal(v.price, 0, 0) + ' VNƒê'}"></span>
          </span>
        </td>

        <td th:text="${v.quantityInStock}"></td>


        <td th:text="${v.discount != null ? v.discount + '%' : '0%'}"></td>
        <td th:text="${v.discountStart}"></td>
        <td th:text="${v.discountEnd}"></td>
        <td>
          <a th:href="@{/variants/edit/{id}(id=${v.variantID})}">
            <button type="button" class="edit-btn">S·ª≠a</button>
          </a>
          <a th:href="@{/variants/delete/{id}(id=${v.variantID})}" th:onclick="'return confirm(\'X√≥a phi√™n b·∫£n?\')'">
            <button type="button" class="delete-btn">X√≥a</button>
          </a>
        </td>

      </tr>
    </tbody>

  </table>
</body>

</html>
 <script>
    // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng gi√° ti·ªÅn
    const priceInput = document.getElementById('priceInput');
    const priceHidden = document.getElementById('priceHidden');

    priceInput.addEventListener('input', function() {
        let raw = this.value.replace(/\D/g, '');
        let formatted = new Intl.NumberFormat('vi-VN').format(raw);
        this.value = formatted;
        priceHidden.value = raw;
    });

    // Kh·ªüi t·∫°o gi√° tr·ªã n·∫øu c√≥
    if (priceHidden.value) {
        priceInput.value = new Intl.NumberFormat('vi-VN').format(priceHidden.value);
    }
  </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const productSelect = document.getElementById("productSelect");
    const storageSelect = document.getElementById("storageSelect");

    productSelect.addEventListener("change", function () {
      const selectedOption = this.options[this.selectedIndex];
      const storagesStr = selectedOption.getAttribute("data-storages");

      // Reset select
      storageSelect.innerHTML = '<option value="">-- Ch·ªçn dung l∆∞·ª£ng --</option>';

      if (storagesStr) {
        const cleaned = storagesStr.replaceAll('[', '').replaceAll(']', '').replaceAll("'", "").trim();
        const storages = cleaned.split(',').map(s => s.trim()).filter(s => s);

        storages.forEach(storage => {
          const option = document.createElement("option");
          option.value = storage;
          option.textContent = storage;
          storageSelect.appendChild(option);
        });
      }
    });
  });
</script>