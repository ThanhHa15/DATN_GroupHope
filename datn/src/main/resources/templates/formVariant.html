<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>Th√™m phi√™n b·∫£n</title>
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <style>
    body {
      background-color: #f0f3f7;
      margin: 0;
      font-family: "Poppins", sans-serif;
      color: #2c3e50;
    }

    table {
      width: 1210px;
      border-collapse: collapse;
      margin-top: 20px;
      width: 1180px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    h2 {
      margin-top: 130px;
      margin-left: 360px;
      text-align: center;
    }

    div+h1 {
      font-size: 23px;
      margin-top: 73px;
      margin-left: 295px;
      margin-bottom: 10px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    form {
      margin-top: 20px;
      max-width: 400px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"],
    select {
      width: 120%;
      padding: 10px;
      border: 1px solid #ddd;
      /* border-radius: 4px; */
      box-sizing: border-box;
      height: 40px;
    }

    button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .edit-btn {
      background-color: #2980b9;
      color: white;
    }

    .delete-btn {
      background-color: #e74c3c;
      color: white;
    }

    .save-btn {
      background-color: #2ecc71;
      color: white;
      padding: 5px;
    }

    .product-image {
      height: 50px;
      display: block;
      margin: 0 auto;
    }

    .discounted-price {
      color: #e74c3c;
      font-weight: bold;
    }

    .original-price {
      color: #95a5a6;
      text-decoration: line-through;
      font-size: 0.9em;
    }

    .container2 {
      width: 1400px;
      /* margin-top: 100px; */
      display: flex;
      margin-left: 295px;
      /* background:white ; */
      height: 570px;
      border-radius: 6px;
      margin-bottom: 59px;
    }

    form {
      flex-direction: row;
    }

    .container2 form:first-child {
      flex: 1;
      /* margin-right: 200px;*/
      margin-left: 40px;
    }

    .container2 form:last-child {
      flex: 2;
    }

    .container2 form:last-child>input {
      margin-top: 10px;
      height: 40px;
    }

    .container2 form:last-child>label+select+select {
      margin-top: 30px;
      height: 40px;
    }

    .form-container2 {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);

      border: 1px solid #ddd;
      margin-right: 20px;
      width: 42%;
      height: 600px;
      box-shadow: 5px 5px 5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div th:replace="nav :: na"></div>
  <div th:replace="header :: header"></div>

  <h1>Th√™m / C·∫≠p nh·∫≠t phi√™n b·∫£n s·∫£n ph·∫©m</h1>
  <div class="container2">
    <div class="form-container2">
      <!-- <p>Ch·ªçn s·∫£n ph·∫©m v√† ƒëi·ªÅn th√¥ng tin phi√™n b·∫£n m·ªõi.</p> -->
      <form th:action="@{/variants/add}" method="post" th:object="${variant}" enctype="multipart/form-data">
        <label style="font-size: 20px;">Phi√™n b·∫£n s·∫£n ph·∫©m</label><br />
        <input type="hidden" th:field="*{variantID}" />

        <div class="form-group">
          <label for="product">S·∫£n ph·∫©m:</label>
          <select th:field="*{product.productID}" class="form-control" required>
            <!-- M·∫∑c ƒë·ªãnh: kh√¥ng th·ªÉ ch·ªçn l·∫°i, kh√¥ng th·ªÉ submit -->
            <option value="" selected>Ch·ªçn s·∫£n ph·∫©m</option>
            <!-- L·∫∑p danh s√°ch s·∫£n ph·∫©m -->
            <option th:each="p : ${products}" th:value="${p.productID}" th:text="${p.productName}"></option>
          </select>
        </div>

        <div class="form-group">
          <label>M√†u:</label>
          <input type="text" placeholder="M√†u" th:field="*{color}" required />
        </div>

        <div class="form-group">
          <label>Dung l∆∞·ª£ng:</label>
          <select th:field="*{storage}">
            <option value="" selected>Ch·ªçn dung l∆∞·ª£ng</option>
            <option value="128GB">128GB</option>
            <option value="256GB">256GB</option>
            <option value="512GB">512GB</option>
            <option value="1TB">1TB</option>
            <option value="2TB">2TB</option>
          </select>
        </div>

        <div class="form-group">
          <label>S·ªë l∆∞·ª£ng:</label>
          <input type="number" th:field="*{quantityInStock}" required min="0" placeholder="S·ªë l∆∞·ª£ng" />
        </div>

        <div class="form-group">
          <label>Gi√° g·ªëc (VNƒê):</label>
          <input type="text" id="priceInput" placeholder="Gi√° g·ªëc" th:field="*{price}" required
            th:value="${variant.price != null ? #numbers.formatDecimal(variant.price, 0, 'COMMA', 0, 'POINT') : ''}" />
          <input type="hidden" th:field="*{price}" id="priceHidden" />
        </div>

        <div class="form-group">
          <label>H√¨nh ·∫£nh:</label>
          <input type="file" name="imageFile" accept="image/*" style="border: none" />
          <span th:if="${variant.imagesno2 != null}">
            <img th:src="@{'/images/' + ${variant.imagesno2}}" class="product-image"
              style="max-height: 100px; margin-top: -50px; margin-right: 80px;" />
          </span>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-top: -48px; margin-right: -80px;">
          <button type="submit" class="save-btn">L∆∞u phi√™n b·∫£n</button>
        </div>

      </form>
      <br />
    </div>
    <div class="form-container2">
      <form th:action="@{/admin/discount/apply}" method="post" class="space-y-2">
        <label style="font-size: 20px;">Gi·∫£m gi√° s·∫£n ph·∫©m</label><br />
        <!-- Ch·ªçn s·∫£n ph·∫©m -->
        <label style="margin-top: -5px;">S·∫£n ph·∫©m</label>
        <select name="productId" id="productSelect" required>

          <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
          <option th:each="p : ${products}" th:value="${p.productID}" th:text="${p.productName}"
            th:attr="data-storages=${p.storages}"></option>
        </select>
        <label for="">Phi√™n b·∫£n</label>
        <!-- Ch·ªçn dung l∆∞·ª£ng (l·ªçc theo s·∫£n ph·∫©m) -->
        <select name="storage" id="storageSelect" style="margin-bottom: 10px">
          <option value="">-- Ch·ªçn dung l∆∞·ª£ng --</option>
        </select>

        <!-- Nh·∫≠p ph·∫ßn trƒÉm gi·∫£m gi√° -->
        <label for="">Ph·∫ßn trƒÉm gi·∫£m gi√°</label>
        <input type="number" name="discount" placeholder="Nh·∫≠p ph·∫ßn trƒÉm gi·∫£m" min="0" max="100" required
          style="margin-bottom: 40px" />

        <!-- Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c -->
        <div style="display: flex; flex-direction: column;margin-top: -28px;">
          <label for="startDate" style="margin-bottom: 5px;">Ng√†y b·∫Øt ƒë·∫ßu</label>
          <input type="date" id="startDate" name="startDate" min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
            required style="border: 1px solid rgb(228, 227, 227); padding: 8px; width: 480px;" />
        </div>

        <!-- Ng√†y k·∫øt th√∫c -->
        <div style="display: flex; flex-direction: column;">
          <label for="endDate" style="margin-bottom: 5px;">Ng√†y k·∫øt th√∫c</label>
          <input type="date" id="endDate" name="endDate" min="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"
            required style="border: 1px solid rgb(228, 227, 227); padding: 8px; width: 480px;" />
        </div>

        <button type="submit" class="save-btn" style="margin-top: 45px;">√Åp m√£ gi·∫£m gi√°</button>
        <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói -->
        <script th:if="${error}" type="text/javascript">
          Swal.fire({
            icon: 'error',
            title: 'L·ªói',
            text: '[[${error}]]',
            confirmButtonText: 'OK'
          });
        </script>
        <script th:if="${success}" type="text/javascript">
          Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng',
            text: '[[${success}]]',
            confirmButtonText: 'OK'
          });
        </script>
      </form>
    </div>
  </div>

  <div style="
        background: #ffffff;
        margin-left: 295px;
        margin-top: 10px;
        border-radius: 4px;
        width: 1200px;
      ">
    <h2 style="margin-left: 30px">üìã Danh s√°ch phi√™n b·∫£n</h2>
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>S·∫£n ph·∫©m</th>
          <th>H√¨nh ·∫£nh</th>
          <th>M√†u</th>
          <th>Dung l∆∞·ª£ng</th>
          <th>Gi√°</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi·∫£m gi√°</th>
          <th>B·∫Øt ƒë·∫ßu</th>
          <th>K·∫øt th√∫c</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="v, stat : ${variants}">
          <td th:text="${stat.index + 1}"></td>
          <td th:text="${v.product.productName}"></td>

          <td>
            <img th:src="@{'/images/' + ${v.imagesno2}}" alt="·∫£nh" style="height: 50px" />
          </td>

          <td th:text="${v.color}"></td>
          <td th:text="${v.storage}"></td>

          <!-- Gi√° hi·ªÉn th·ªã: c√≥ gi·∫£m th√¨ hi·ªán 2 d√≤ng, kh√¥ng gi·∫£m th√¨ 1 d√≤ng -->
          <td>
            <span th:if="${v.discountedPrice < v.price}">
              <!-- Gi√° ƒë√£ gi·∫£m: n·ªïi b·∫≠t -->
              <span style="color: #dc2626; font-weight: bold; font-size: 1.125rem"
                th:text="${#numbers.formatDecimal(v.discountedPrice, 0, 0) + ' VNƒê'}">
              </span>
              <br />
              <!-- Gi√° g·ªëc: m·ªù h∆°n, nh·ªè h∆°n -->
              <span style="
                    color: #9ca3af;
                    text-decoration: line-through;
                    font-size: 0.75rem;
                    font-style: italic;
                  " th:text="${#numbers.formatDecimal(v.price, 0, 0) + ' VNƒê'}">
              </span>
            </span>

            <span th:if="${v.discountedPrice == v.price}">
              <span th:text="${#numbers.formatDecimal(v.price, 0, 0) + ' VNƒê'}"></span>
            </span>
          </td>

          <td th:text="${v.quantityInStock}"></td>

          <td th:text="${v.discount != null ? v.discount + '%' : '0%'}"></td>
          <td th:text="${v.discountStart}"></td>
          <td th:text="${v.discountEnd}"></td>
          <td>
            <a th:href="@{/variants/edit/{id}(id=${v.variantID})}">
              <button type="button" class="edit-btn">S·ª≠a</button>
            </a>
            <a th:href="@{/variants/delete/{id}(id=${v.variantID})}" th:onclick="'return confirm(\'X√≥a phi√™n b·∫£n?\')'">
              <button type="button" class="delete-btn">X√≥a</button>
            </a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</body>

</html>
<script>
  // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng gi√° ti·ªÅn
  const priceInput = document.getElementById("priceInput");
  const priceHidden = document.getElementById("priceHidden");

  priceInput.addEventListener("input", function () {
    let raw = this.value.replace(/\D/g, "");
    let formatted = new Intl.NumberFormat("vi-VN").format(raw);
    this.value = formatted;
    priceHidden.value = raw;
  });

  // Kh·ªüi t·∫°o gi√° tr·ªã n·∫øu c√≥
  if (priceHidden.value) {
    priceInput.value = new Intl.NumberFormat("vi-VN").format(priceHidden.value);
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const productSelect = document.getElementById("productSelect");
    const storageSelect = document.getElementById("storageSelect");

    productSelect.addEventListener("change", function () {
      const selectedOption = this.options[this.selectedIndex];
      const storagesStr = selectedOption.getAttribute("data-storages");

      // Reset select
      storageSelect.innerHTML =
        '<option value="">-- Ch·ªçn dung l∆∞·ª£ng --</option>';

      if (storagesStr) {
        const cleaned = storagesStr
          .replaceAll("[", "")
          .replaceAll("]", "")
          .replaceAll("'", "")
          .trim();
        const storages = cleaned
          .split(",")
          .map((s) => s.trim())
          .filter((s) => s);

        storages.forEach((storage) => {
          const option = document.createElement("option");
          option.value = storage;
          option.textContent = storage;
          storageSelect.appendChild(option);
        });
      }
    });
  });
</script>