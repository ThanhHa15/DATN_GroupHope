<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apple Support</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/shared/chatbox.css">
</head>

<body>
    <div th:fragment="siteChatbot" class="chatbot-container">
        <div class="chatbot-toggle" id="chatbotToggle">
            <i class="fas fa-headset fa-lg"></i>
        </div>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                HOPEPHONE
                <span class="close-btn" id="closeBtn"><i class="fas fa-times"></i></span>
            </div>
            <div class="chatbot-body" id="chatbotBody"></div>
            <div class="chatbot-footer">
                <div class="input-group">
                    <div class="menu-btn" id="menuBtn">
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                    <div class="menu-content" id="menuContent">
                        <div class="menu-item">iPhone</div>
                        <div class="menu-item">iPad</div>
                        <div class="menu-item">MacBook</div>
                        <div class="menu-item">Apple Watch</div>
                        <div class="menu-item">Bảo hành</div>
                    </div>
                    <input type="text" class="form-control" id="chatInput" placeholder="Nhập tin nhắn..." />
                    <input type="file" id="fileInput" accept=".jpg,.png,.pdf,.docx" />
                    <label for="fileInput" class="file-upload"><i class="fas fa-paperclip"></i></label>
                    <button class="btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="quick-suggestions" id="quickSuggestions">
                    <div class="quick-suggestion">iPhone</div>
                    <div class="quick-suggestion">iPad</div>
                    <div class="quick-suggestion">MacBook</div>
                    <div class="quick-suggestion">Cần hỗ trợ kỹ thuật</div>
                </div>
                <div class="contact-info">
                    <a href="tel:18006932533"><i class="fas fa-phone"></i> 1800-693-2533</a>
                    <a href="mailto:support@apple.com"><i class="fas fa-envelope"></i> support@apple.com</a>
                </div>
            </div>
        </div>

        <script>
          
            // Toggle mở / đóng chatbot
            document.getElementById("chatbotToggle").addEventListener("click", () => {
                const windowEl = document.getElementById("chatbotWindow");
                if (windowEl.style.display === "none" || windowEl.style.display === "") {
                    windowEl.style.display = "flex";
                } else {
                    windowEl.style.display = "none";
                }
            });

            // Nút đóng
            document.getElementById("closeBtn").addEventListener("click", () => {
                document.getElementById("chatbotWindow").style.display = "none";
            });

            // Menu toggle
            const menuBtn = document.getElementById("menuBtn");
            const menuContent = document.getElementById("menuContent");
            menuBtn.addEventListener("click", e => {
                e.preventDefault();
                menuContent.classList.toggle("show");
            });

            // Menu item click → gọi API
            document.querySelectorAll(".menu-item").forEach(item => {
                item.addEventListener("click", function () {
                    menuContent.classList.remove("show");
                    sendUserMessage("Hỗ trợ về: " + this.textContent);
                });
            });

            // Enter key → gọi API
            document.getElementById("chatInput").addEventListener("keypress", function (e) {
                if (e.key === "Enter" && this.value.trim()) {
                    const message = this.value.trim();
                    this.value = "";
                    sendUserMessage(message);
                }
            });

            // Hiển thị typing
            function showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chat-message bot typing';
                typingDiv.innerHTML = '<em>Táo Biết Tuốt đang nhập...</em>';
                typingDiv.id = 'typing-indicator';
                chatbotBody.appendChild(typingDiv);
                chatbotBody.scrollTop = chatbotBody.scrollHeight;
            }

            // Ẩn typing
            function hideTypingIndicator() {
                const typingDiv = document.getElementById('typing-indicator');
                if (typingDiv) typingDiv.remove();
            }

            // Gửi tin nhắn đến API
            function sendUserMessage(message) {
                addMessage("user", message);
                showTypingIndicator();

                fetch("/api/chatbot/query", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message })
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Network response was not ok");
                        return res.json();
                    })
                    .then(data => {
                        hideTypingIndicator();
                        addMessage("bot", data.message);
                        if (data.hasMatch && data.product) {
                            const productHtml = renderProductCard(data.product, data.variants || []);
                            addMessage("bot", productHtml, true);
                        }
                    })
                    .catch(err => {
                        hideTypingIndicator();
                        addMessage("bot", "Xin lỗi, đã có lỗi xảy ra. Vui lòng thử lại.");
                        console.error("Error:", err);
                    });
            }

            // Render thẻ sản phẩm + biến thể

            const chatbotBody = document.getElementById("chatbotBody");
            const PLACEHOLDER_IMG = "/images/ip1164.png";

            // Lấy giá trị cột ảnh trong product
            function pickImageField(product) {
                const keys = ["imageUrl", "image", "imagePath", "thumbnail", "img", "image_name", "imageFile", "avatar"];
                for (const k of keys) {
                    const v = (product?.[k] ?? "").toString().trim();
                    if (v) return v;
                }
                return "";
            }

            // Chuẩn hoá src: ưu tiên URL tuyệt đối/đường dẫn tuyệt đối; nếu chỉ là tên file -> dùng /images/<file>
            function getImageSrc(product) {
                let file = pickImageField(product);

                if (!file) {
                    return {
                        src: PLACEHOLDER_IMG,
                        fallback: PLACEHOLDER_IMG
                    };
                }

                // DB chỉ lưu tên file → gắn trực tiếp vào /images/
                file = file.replace(/^images[\\/]/i, "").replace(/^uploads[\\/]/i, "");

                return {
                    src: `/images/${encodeURIComponent(file)}`,     // ảnh thật trong static/images/
                    fallback: `/uploads/${encodeURIComponent(file)}` // fallback (sau này có thể thêm)
                };
            }



            // Tạo đường fallback: nếu đang /images/ thì thử /uploads/, và ngược lại
            function makeFallback(src) {
                if (src.includes("/images/")) return src.replace("/images/", "/uploads/");
                if (src.includes("/uploads/")) return src.replace("/uploads/", "/images/");
                return PLACEHOLDER_IMG;
            }

            // Khi render từng product:
            function renderProductCard(product) {
                const { src, fallback } = getImageSrc(product);

                return `
            <div class="product-card">
                <img src="${src}" 
                     alt="${product.productName || 'Sản phẩm'}"
                     style="width:80px;height:80px;object-fit:cover;border-radius:8px;flex-shrink:0;"
                     loading="lazy"
                     data-fallback="${fallback}"
                     onerror="
                        if (this.dataset.tried !== '1') {
                            this.dataset.tried = '1';
                            this.src = this.dataset.fallback || '${PLACEHOLDER_IMG}';
                        } else {
                            this.src = '${PLACEHOLDER_IMG}';
                        }
                     ">
                <div class="product-info">
                    <h4>${product.productName}</h4>
                </div>
            </div>
        `;
            }




            // Thêm tin nhắn vào khung chat
            function addMessage(type, text, isHtml = false) {
                const message = document.createElement("div");
                message.classList.add("chat-message", type);

                if (isHtml) {
                    // Giữ nguyên HTML (có thể chứa <a>) để click được
                    message.innerHTML = `
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
                ${text}
            `;
                } else {
                    // Tin nhắn thường thì escape để chống XSS
                    message.innerHTML = `
                <div class="message-content">${escapeHtml(text)}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
                }

                chatbotBody.appendChild(message);
                chatbotBody.scrollTop = chatbotBody.scrollHeight;
            }

            // Escape HTML để chống XSS
            function escapeHtml(unsafe) {
                return unsafe.replace(/[&<"'>]/g, m => ({
                    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
                }[m]));
            }
        </script>

    </div>
</body>

</html>