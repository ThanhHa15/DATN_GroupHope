<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông tin chi tiết sản phẩm</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>tailwind.config = { theme: { extend: { colors: { primary: '#e11d48', secondary: '#f97316' }, borderRadius: { 'none': '0px', 'sm': '4px', DEFAULT: '8px', 'md': '12px', 'lg': '16px', 'xl': '20px', '2xl': '24px', '3xl': '32px', 'full': '9999px', 'button': '8px' } } } }</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/shared/footer.css">
  <link rel="stylesheet" href="/css/shared/header.css">
  <link rel="stylesheet" href="/css/shared/chatbox.css">
  <style>
    :where([class^="ri-"])::before {
      content: "\f3c2";
    }

    body {
      font-family: "Roboto", sans-serif;
    }

    .banner-slide {
      transition: transform 0.5s ease;
    }

    .custom-scrollbar::-webkit-scrollbar {
      height: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #e11d48;
      border-radius: 4px;
    }

    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #e2e8f0;
      border-radius: 4px;
      position: relative;
      cursor: pointer;
    }

    input[type="checkbox"]:checked {
      background-color: #e11d48;
      border-color: #e11d48;
    }

    input[type="checkbox"]:checked::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 5px;
      width: 5px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 200px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 50;
      border-radius: 8px;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    .border-custom-blue {
      border-color: #000f8f;
      /* Màu xanh tùy chỉnh */
    }

    .thumbnail.active {
      border-color: #3b82f6 !important;
      /* blue-500 */
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
      /* glow effect */
    }
  </style>

  <style>
    .product-images-wrapper {
      height: calc(100% + 200px);
      /* Thêm 200px vào chiều cao tự nhiên */
    }

    .product-images-scrollable {
      position: sticky;
      top: 20px;
      transition: transform 0.3s ease;
      will-change: transform;
    }

    @media (min-width: 1024px) {
      .product-images-scrollable {
        transform: translateY(0);
        max-height: calc(100vh - 40px);
      }

      /* Khi scroll vượt quá 200px */
      body.scrolled .product-images-scrollable {
        transform: translateY(200px);
      }
    }
  </style>

  <!-- Nút xem tất cả -->
  <style>
    .xem-tat-ca-btn {
      display: block;
      margin: 16px auto 0;
      padding: 8px 24px;
      border: 1px solid #000f8f;
      color: #000f8f;
      border-radius: 4px;
      background-color: transparent;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .xem-tat-ca-btn:hover {
      background-color: #000f8f;
      color: white;
    }

    .xem-tat-ca-btn:hover .arrow-icon {
      transform: translateX(10px);
    }

    .arrow-icon {
      transition: transform 0.3s ease;
    }
  </style>
</head>

<body class="bg-[#f2f2f2]">
  <!-- Header -->
  <div th:insert="views/shared/header :: siteHeader" style="margin-top: 120px;"></div>
  <!-- chatbox -->
  <div th:insert="views/shared/chatbot :: siteChatbot"></div>
  <!-- Zalo icon -->
  <div th:insert="views/shared/zalo :: siteZalo"></div>

  <section class="py-8">
    <div class="container mx-auto px-4">
      <!-- Đoạn 1 -->
      <div class="bg-white rounded-lg p-6 mb-6 shadow-[0_0_15px_rgba(0,0,0,0.1)]"
        style="max-width: 1250px; margin: auto">
        <!-- Tiêu đề sản phẩm -->
        <div class="flex items-center justify-between mb-8">
          <div class="w-full">
            <h2 class="text-xl font-bold pb-3 border-b border-gray-700" style="font-size: 23px;">
              <span th:text="${v.product.productName} ">Tên sản phẩm</span>
              <span> </span>
              <span th:text="${v.storage} + ' - ' + 'Chính hãng VN'">Dung lượng</span>
              <span></span>
            </h2>
          </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
          <!-- Phần 1: Ảnh sản phẩm -->
          <div class="product-images-wrapper relative lg:w-1/3">
            <div class="product-images-scrollable">
              <!-- Ảnh lớn chính -->
              <div class="main-image mb-3">
                <img id="main-image" th:src="@{'/images/' + ${v.imagesno2}}" th:alt="${v.product.productName}"
                  class="w-full h-auto transition-opacity duration-300" />
              </div>

              <!-- Ảnh nhỏ phía dưới -->
              <div class="thumbnail-images grid grid-cols-4 gap-2 w-full">
                <!-- Lặp qua các biến thể cùng dung lượng -->
                <div th:each="variant : ${sameStorageVariants}"
                  class="thumbnail cursor-pointer border-2 rounded-lg transition-all p-1 flex items-center justify-center bg-gray-50"
                  th:classappend="${v.variantID == variant.variantID} ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-300' : 'border-transparent'">
                  <a th:href="@{'/detail/' + ${variant.variantID}}">
                    <img th:src="@{'/images/' + ${variant.imagesno2}}" th:alt="${variant.color}"
                      class="h-auto max-w-full object-contain" />
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Phần 2: Thông tin cơ bản và giá -->
          <div class="lg:w-2/4" style="margin-right: -20px">
            <!-- Thông tin cơ bản -->
            <div class="mb-6">
              <div class="mb-4">
                <div class="grid grid-cols-2 gap-x-8 gap-y-2">
                  <p style="color: #000f8f; font-weight: 600">
                    <span class="text-gray-600" style="font-weight: 500">Loại:</span>
                    <span th:text="${v.product.category.name}">Tên danh mục</span>
                  </p>

                  <p style="color: #000f8f; font-weight: 500">
                    <span class="text-gray-600" style="font-weight: 500">Tình trạng:</span>
                    <span th:if="${v.quantityInStock > 0}" style="color: #000f8f; font-weight: 600;">Còn hàng</span>
                    <span th:unless="${v.quantityInStock > 0}" style="color: #000f8f; font-weight: 600;">Hết hàng</span>
                  </p>
                </div>
              </div>

              <!-- Giá bán -->
              <div class="mb-6" style="margin-bottom: 3px">
                <h2 class="text-[16px] text-gray-800 font-medium mb-2" style="margin-bottom: 0px; font-weight: 600;">
                  Giá bán:
                </h2>
                <div class="flex items-center space-x-4">
                  <!-- Nếu có giảm giá -->
                  <div th:if="${v.discountedPrice < v.price}" class="flex items-center gap-2">
                    <!-- Giá đã giảm -->
                    <h2 class=" font-bold text-red-600 m-0" style="font-size: 37px;"
                      th:text="${#strings.replace(#numbers.formatDecimal(v.discountedPrice, 0, 'COMMA', 0, 'POINT'), ',', '.')} + ' ₫'">
                    </h2>

                    <!-- Giá gốc gạch ngang -->
                    <span class="text-base text-gray-500 line-through"
                      th:text="${#strings.replace(#numbers.formatDecimal(v.price, 0, 'COMMA', 0, 'POINT'), ',', '.')} + ' ₫'">
                    </span>

                    <!-- Phần trăm giảm -->
                    <span class="bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded"
                      th:text="'-' + ${v.discount} + '%'">
                    </span>
                  </div>

                  <!-- Nếu không giảm -->
                  <div th:if="${v.discountedPrice == v.price}">
                    <h2 class="text-2xl font-bold text-red-600"
                      style="font-size: 37px; margin-top: 11px; margin-bottom: 12px;"
                      th:text="${#strings.replace(#numbers.formatDecimal(v.price, 0, 'COMMA', 0, 'POINT'), ',', '.')} + ' ₫'">
                    </h2>
                  </div>


                </div>
              </div>

              <!-- Dung lượng -->
              <div class="mb-6 mt-2">
                <h2 class="text-[16px] text-gray-800 font-medium mb-2" style="font-weight: 600; margin-bottom: 5px;">
                  Dung lượng:</h2>
                <div class="flex gap-4 flex-wrap">
                  <!-- Chỉ hiển thị nếu có dung lượng -->
                  <div th:each="variant : ${uniqueVariantsByStorage}"
                    th:if="${variant.storage != null and !#strings.isEmpty(variant.storage)}" class="w-full sm:w-auto">

                    <a th:href="@{/detail/{id}(id=${variant.variantID})}">
                      <label
                        class="relative border-2 border-gray-300 rounded-md px-6 py-3 cursor-pointer hover:border-blue-500 transition-all text-center block w-[150px]"
                        th:classappend="${v.storage == variant.storage} ? ' border-blue-500 bg-blue-50 ring-2 ring-blue-300' : ''">

                        <!-- Hiển thị dung lượng -->
                        <span class="block font-medium text-gray-900" style="font-weight: 500;"
                          th:text="${variant.storage}">Dung lượng</span>

                        <!-- Hiển thị giá cuối cùng -->
                        <span class="text-red-600 font-semibold block mt-1"
                          th:text="${#numbers.formatInteger(variant.discountedPrice, 0, 'POINT')} + 'đ'">Giá</span>

                        <!-- Dấu tick khi chọn -->
                        <span
                          class="absolute -top-2 -left-2 bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                          th:classappend="${v.storage == variant.storage} ? 'opacity-100' : 'opacity-0'">✔</span>
                      </label>
                    </a>
                  </div>
                </div>
              </div>

              <!-- Màu sắc -->
              <div class="mb-6" style="margin-bottom: 10px">
                <h2 class="text-[16px] text-gray-800 font-medium mb-3"
                  style="margin-bottom: 0px; font-weight: 600; margin-top: -10px;">
                  Màu sắc:
                </h2>
                <div class="flex flex-wrap gap-3">
                  <label th:each="variant, iterStat : ${sameStorageVariants}"
                    class="relative border-2 border-gray-300 rounded-lg p-1 cursor-pointer hover:border-blue-400 transition-all has-[:checked]:border-blue-500 has-[:checked]:ring-2 has-[:checked]:ring-blue-200">

                    <input type="radio" name="mausac" th:value="${variant.color}" class="hidden peer color-option"
                      th:checked="${v.variantID == variant.variantID}" th:attr="data-variant-id=${variant.variantID}" />

                    <div
                      class="w-16 h-16 flex items-center justify-center border-none peer-checked:border-white peer-checked:ring-2 peer-checked:ring-white rounded-lg transition-all">
                      <img th:src="@{'/images/' + ${variant.imagesno2}}" th:alt="${variant.color}"
                        class="h-full object-contain" />
                    </div>


                    <span class="block text-center text-xs mt-1 peer-checked:text-blue-600"
                      th:text="${variant.color}"></span>

                    <span
                      class="absolute -top-2 -right-2 bg-blue-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center opacity-0 peer-checked:opacity-100">✔</span>
                  </label>
                </div>
              </div>

              <!-- Số lượng -->
              <div class="mb-6" style="margin-bottom: 10px">
                <h2 class="text-[15px] font-medium mb-3" style="margin-bottom: 2px">
                  Số lượng:
                </h2>
                <div class="flex items-center">
                  <!-- Nút giảm -->
                  <button type="button" id="decreaseQty"
                    class="quantity-btn bg-[#000f8f] text-white w-8 h-8 flex items-center justify-center rounded-sm hover:bg-[#000b6e]">
                    <i class="ri-subtract-line"></i>
                  </button>

                  <!-- Input số lượng -->
                  <input type="number" id="quantity" value="1" min="1" max="99"
                    class="quantity-input w-12 h-8 text-center border-t border-b border-gray-300 mx-1" />

                  <!-- Nút tăng -->
                  <button type="button" id="increaseQty" style="margin-left: -5px;"
                    class="quantity-btn bg-[#000f8f] text-white w-8 h-8 flex items-center justify-center rounded-sm hover:bg-[#000b6e]">
                    <i class="ri-add-line"></i>
                  </button>
                </div>

              </div>

              <!-- Thêm vào giỏ -->
              <div class="mb-6 space-y-4" style="margin-bottom: 10px">

                <!-- Hàng 1: Nút THÊM VÀO GIỎ (to nhất) -->
                <button
                  class="w-full h-[60px] bg-yellow-500 hover:bg-yellow-600 text-white py-4 px-6 rounded-sm transition-all duration-300 flex flex-col items-center justify-center transform hover:-translate-y-1 shadow-md hover:shadow-lg"
                  style="margin-bottom: -5px" th:attr="data-variant-id=${v.variantID}" onclick="addToCart(this)">

                  <span class="font-medium text-medium" style="margin-top: 10px">THÊM VÀO GIỎ</span>
                  <span class="text-sm" style="margin-bottom: 8px">Giao hàng tận nơi miễn phí</span>
                </button>


                <!-- Hàng 2: 2 nút MUA NGAY và LIÊN HỆ cùng hàng -->
                <div class="grid grid-cols-2 gap-4">
                  <!-- Nút MUA NGAY -->
                  <button
                    class="bg-[#000f8f] hover:bg-[#000d7a] h-[60px] text-white py-3 px-4 rounded-sm transition-all duration-300 flex flex-col items-center justify-center transform hover:-translate-y-1 shadow-md hover:shadow-lg">
                    <span class="font-medium text-medium">MUA NGAY</span>
                  </button>

                  <!-- Nút LIÊN HỆ -->
                  <button
                    class="bg-[#000f8f] hover:bg-[#000d7a] h-[60px] text-white py-3 px-4 rounded-sm transition-all duration-300 flex flex-col items-center justify-center transform hover:-translate-y-1 shadow-md hover:shadow-lg">
                    <span class="font-medium text-sm">Liên hệ
                      <span class="text-[18px]">1900 xxxx</span></span>
                    <span class="text-sm mt-1">Để được tư vấn và hỗ trợ ngay!!!</span>
                  </button>
                </div>
              </div>

              <!-- Ưu đãi khi mua hàng -->
              <div class="border-[1.5px] border-black rounded-xl overflow-hidden text-sm" style="margin-bottom: -30px">
                <!-- Tiêu đề với nền xanh đậm + icon -->
                <div class="bg-[#000f8f] text-white px-4 py-3 flex items-center font-semibold"
                  style="margin-bottom: -10px">
                  <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      d="M2 7h16v10a2 2 0 01-2 2H4a2 2 0 01-2-2V7zm16-2V3a1 1 0 00-1-1h-2.28a2 2 0 00-3.92 0H9.2a2 2 0 00-3.92 0H3a1 1 0 00-1 1v2h16z" />
                  </svg>
                  Ưu đãi khi mua hàng
                </div>

                <!-- Danh sách ưu đãi -->
                <ul class="p-4 space-y-2 text-[15px]">
                  <li class="flex items-start">
                    <span class="text-purple-500 mr-2 mt-1">✔</span>
                    <span>Hỗ trợ trả góp 0% chỉ cần CCCD gắn chip hoặc 0% qua thẻ
                      tín dụng</span>
                  </li>
                  <li class="flex items-start">
                    <span class="text-purple-500 mr-2 mt-1">✔</span>
                    <span>Nhập mã <strong>ZALOPAYMT</strong> giảm ngay 1% tối đa
                      <strong>200.000đ</strong> khi thanh toán qua Zalo
                      Pay</span>
                  </li>
                  <li class="flex items-start">
                    <span class="text-purple-500 mr-2 mt-1">✔</span>
                    <span>Giảm 50% tối đa <strong>100.000đ</strong> cho thành
                      viên mới của Kredivo</span>
                  </li>
                  <li class="flex items-start">
                    <span class="text-purple-500 mr-2 mt-1">✔</span>
                    <span>Giảm 5% tối đa <strong>200.000đ</strong>, áp dụng kỳ
                      hạn 6/12 tháng khi thanh toán qua Kredivo</span>
                  </li>
                  <li class="flex items-start">
                    <span class="text-purple-500 mr-2 mt-1">✔</span>
                    <span>Giảm 50% tối đa <strong>100.000đ</strong>, áp dụng cho
                      đơn hàng từ <strong>200.000đ</strong> cho người dùng mới
                      của Home Pay Later</span>
                  </li>
                  <li class="flex items-start">
                    <span class="text-purple-500 mr-2 mt-1">✔</span>
                    <span>Giảm 5% tối đa <strong>200.000đ</strong> cho đơn từ
                      <strong>200.000đ</strong> khi thanh toán qua Home
                      PayLater</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Phần 3: Thông tin mua hàng -->
          <div class="lg:w-2/7">
            <!-- Hệ thống cửa hàng -->
            <div class="border-[1.5px] border-black rounded-md overflow-hidden text-sm mb-5"
              style="margin-bottom: 20px">
              <!-- Tiêu đề -->
              <div class="bg-[#000f8f] text-white px-4 py-3 flex items-center font-semibold"
                style="margin-bottom: -10px; padding-left: 7px">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    d="M10.707 1.293a1 1 0 00-1.414 0L3 7.586V17a1 1 0 001 1h4a1 1 0 001-1v-4h2v4a1 1 0 001 1h4a1 1 0 001-1V7.586l-6.293-6.293z" />
                </svg>Hệ thống cửa hàng
              </div>

              <!-- Danh sách cửa hàng -->
              <div class="p-4 space-y-4 text-[15px] leading-snug" style="padding-left: px">
                <div>
                  <p class="text-[#000f8f] font-semibold">Hope Sài Gòn</p>
                  <p><strong>Địa chỉ:</strong> 123 Lê Lợi, Quận 1, TP.HCM</p>
                </div>
                <div>
                  <p class="text-[#000f8f] font-semibold">Hope Hà Nội</p>
                  <p>
                    <strong>Địa chỉ:</strong> 456 Phố Huế, Hai Bà Trưng, Hà
                    Nội
                  </p>
                </div>
                <div>
                  <p class="text-[#000f8f] font-semibold">Hope Đà Nẵng</p>
                  <p>
                    <strong>Địa chỉ:</strong> 789 Nguyễn Văn Linh, Hải Châu,
                    Đà Nẵng
                  </p>
                </div>
                <div>
                  <p class="text-[#000f8f] font-semibold">Hope Cần Thơ</p>
                  <p>
                    <strong>Địa chỉ:</strong> 321 Hùng Vương, Ninh Kiều, Cần
                    Thơ
                  </p>
                </div>
              </div>
            </div>

            <!-- Cam kết bán hàng -->
            <div class="border-[1.5px] border-black rounded-md overflow-hidden text-sm mb-5"
              style="margin-bottom: 20px">
              <div class="rounded-md overflow-hidden w-full max-w-md">
                <!-- Tiêu đề -->
                <div class="bg-[#000f8f] text-white px-4 py-2 flex items-center space-x-2" style="margin-bottom: -8px">
                  <i class="fa-solid fa-bookmark text-white"></i>
                  <h3 class="text-base font-semibold">Cam kết bán hàng</h3>
                </div>

                <!-- Nội dung -->
                <ul class="p-4 space-y-3 text-[15px] leading-snug">
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-shield-halved text-gray-700 pt-1"></i>
                    <span>Hàng chính hãng. Nguồn gốc rõ ràng</span>
                  </li>
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-gift text-gray-700 pt-1"></i>
                    <span>Tặng máy nếu phát hiện máy sửa chữa</span>
                  </li>
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-truck-fast text-gray-700 pt-1"></i>
                    <span>Giao hàng ngay (nội thành TPHCM)</span>
                  </li>
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-calendar-check text-gray-700 pt-1"></i>
                    <span>Dùng thử 7 ngày miễn phí</span>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Danh sách khuyến mãi -->
            <div class="border-[1.5px] border-black rounded-md overflow-hidden text-sm mb-5"
              style="margin-bottom: 10px">
              <div class="rounded-md overflow-hidden w-full max-w-md">
                <!-- Tiêu đề -->
                <div class="bg-[#000f8f] text-white px-4 py-2 flex items-center space-x-2" style="margin-bottom: -8px">
                  <i class="fa-solid fa-bolt"></i>

                  <h3 class="text-base font-semibold">
                    Danh sách khuyến mãi
                  </h3>
                </div>
                <!-- Nội dung -->
                <ul class="p-4 space-y-3 text-[15px] leading-snug">
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-gift text-red-500" style="margin-top: 6px"></i>
                    <span><b>Voucher DATN2808</b>: Giảm ngay <b>30%</b> cho mọi đơn hàng.
                      Số lượng có hạn, nhanh tay sử dụng kẻo hết!</span>
                  </li>
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-gift text-green-500" style="margin-top: 6px"></i>
                    <span><b>Voucher HOPEPHONE</b>: Giảm <b>10%</b> cho đơn hàng từ
                      <b>5.000.000₫</b>. Áp dụng cho tất cả sản phẩm Apple!</span>
                  </li>
                  <li class="flex items-start space-x-2">
                    <i class="fa-solid fa-check text-blue-500" style="margin-top: 6px"></i>
                    <span>Áp dụng trực tiếp khi nhập mã tại bước thanh toán.</span>
                  </li>
                </ul>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Đoạn 2 -->
      <div class="reviews-section flex flex-row gap-6 items-stretch" data-product-id="${v.product.productID}"
        style="max-width: 1250px; margin: auto; margin-top: 20px; margin-bottom: 20px;">
        <!-- Phần 6/10 -->
        <div class="w-6/10 flex-6 basis-3/5 bg-white rounded-lg p-6 mb-6 shadow-[0_0_15px_rgba(0,0,0,0.1)]">
          <div class="flex items-center justify-between mb-8" style="margin-bottom: 5px">
            <h2 class="text-2xl font-bold border-l-8 border-custom-blue pl-4">
              ĐÁNH GIÁ SẢN PHẨM
            </h2>
          </div>

          <!-- Product Review Section -->
          <div class="bg-[#f5f9f6] p-4 rounded-md border text-sm">
            <!-- Overview + Filter -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-4 mb-5">
              <!-- Overview -->
              <div class="text-center lg:text-left" style="margin-left: 28px">
                <p class="text-2xl text-green-600 font-semibold" style="margin-left: 9px" id="average-rating">
                  0/5
                </p>
                <div class="flex justify-center lg:justify-start text-yellow-500 mb-1" id="average-stars">
                  <i class="fa-solid fa-star"></i>
                  <i class="fa-solid fa-star"></i>
                  <i class="fa-solid fa-star"></i>
                  <i class="fa-solid fa-star"></i>
                  <i class="fa-solid fa-star"></i>
                </div>
                <p class="text-gray-600" id="total-reviews">(0 đánh giá)</p>
                <button id="openReviewModal" style="margin-left: -36px"
                  class="mt-2 px-4 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                  Gửi đánh giá của bạn
                </button>
              </div>

              <!-- Review Filter -->
              <div class="flex flex-wrap justify-center gap-2 p-2 rounded-md border-gray-800">
                <button data-rating="5"
                  class="filter-button border border-gray-300 px-3 py-1 rounded-md hover:bg-gray-100 hover:border-gray-500 transition-all">
                  5 sao (0)
                </button>
                <button data-rating="4"
                  class="filter-button border border-gray-300 px-3 py-1 rounded-md hover:bg-gray-100 hover:border-gray-500 transition-all">
                  4 sao (0)
                </button>
                <button data-rating="3"
                  class="filter-button border border-gray-300 px-3 py-1 rounded-md hover:bg-gray-100 hover:border-gray-500 transition-all">
                  3 sao (0)
                </button>
                <button data-rating="2"
                  class="filter-button border border-gray-300 px-3 py-1 rounded-md hover:bg-gray-100 hover:border-gray-500 transition-all">
                  2 sao (0)
                </button>
                <button data-rating="1"
                  class="filter-button border border-gray-300 px-3 py-1 rounded-md hover:bg-gray-100 hover:border-gray-500 transition-all">
                  1 sao (0)
                </button>
                <button data-rating="0"
                  class="filter-button border border-gray-300 px-3 py-1 rounded-md hover:bg-gray-100 hover:border-gray-500 transition-all active-filter">
                  Tất cả
                </button>
              </div>
            </div>

            <!-- Reviews List -->
            <div class="space-y-6" id="reviews-container">
              <!-- Reviews will be loaded here dynamically -->
            </div>
          </div>
        </div>
        <!-- Phần 4/10 -->
        <div class="w-4/10 basis-2/5  bg-white rounded-lg p-6 flex flex-col shadow-[0_0_15px_rgba(0,0,0,0.1)]">
          <!-- Tiêu đề -->
          <div class="bg-[#000f8f] text-white px-4 py-2 rounded-md flex items-center space-x-2 mb-2"
            style="margin-top: -7px">
            <i class="fa-solid fa-gear"></i>
            <h3 class="font-semibold text-base">Thông số kỹ thuật</h3>
          </div>

          <!-- Danh sách thông số -->
          <div class="space-y-2 text-sm relative" style="position: relative">
            <div th:each="spec, iterStat : ${specifications}" th:if="${iterStat.index < 20}"
              th:class="${iterStat.index % 2 == 0} ? 'flex bg-white' : 'flex bg-gray-200'">
              <div class="w-1/2 px-4 py-2 font-medium" th:text="${#strings.replace(spec.specKey, '''', '')}"></div>
              <div class="w-1/2 px-4 py-2" th:utext="${#strings.replace(spec.specValue, '\n', '<br/>')}"></div>
            </div>

            <div class="text-center mt-4">
              <button onclick="toggleFullSpecs()"
                class="px-6 py-2 border border-[#000f8f] text-[#000f8f] rounded hover:bg-[#000f8f] hover:text-white transition">
                Xem tất cả </button>
            </div>
          </div>
        </div>
      </div>


      <!-- Review Modal -->
      <div id="reviewModal"
        class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center hidden z-50 transition-opacity duration-300">
        <div
          class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-lg mx-4 transform transition-all duration-300 scale-95 hover:scale-100">
          <!-- Modal Header -->
          <div class="bg-[#000f8f] p-6">
            <h3 class="text-2xl font-bold text-white">Đánh giá sản phẩm</h3>
            <p class="text-blue-100">Chia sẻ trải nghiệm của bạn về sản phẩm</p>
          </div>

          <!-- Modal Content -->
          <div class="p-6 space-y-6">
            <!-- Rating Section -->
            <div class="space-y-2">
              <label class="block text-gray-700 font-medium">Đánh giá của bạn</label>
              <div class="flex text-3xl space-x-2 rating-stars">
                <i class="fa-regular fa-star cursor-pointer text-amber-400 hover:text-amber-500 transition-colors"
                  data-value="1"></i>
                <i class="fa-regular fa-star cursor-pointer text-amber-400 hover:text-amber-500 transition-colors"
                  data-value="2"></i>
                <i class="fa-regular fa-star cursor-pointer text-amber-400 hover:text-amber-500 transition-colors"
                  data-value="3"></i>
                <i class="fa-regular fa-star cursor-pointer text-amber-400 hover:text-amber-500 transition-colors"
                  data-value="4"></i>
                <i class="fa-regular fa-star cursor-pointer text-amber-400 hover:text-amber-500 transition-colors"
                  data-value="5"></i>
              </div>
              <input type="hidden" id="ratingValue" value="0">
              <p class="text-sm text-gray-500">Nhấn để chọn số sao</p>
            </div>

            <!-- Comment Section -->
            <div class="space-y-2">
              <label for="reviewComment" class="block text-gray-700 font-medium">Bình luận</label>
              <textarea id="reviewComment" rows="4"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#000f8f] focus:border-transparent transition-all"
                placeholder="Hãy chia sẻ chi tiết về trải nghiệm của bạn..."></textarea>
            </div>

            <!-- Image Upload Section -->
            <div class="space-y-2">
              <label class="block text-gray-700 font-medium">Ảnh đính kèm <span class="text-sm text-gray-500">
                </span></label>
              <div class="flex items-center justify-center w-full">
                <label for="imageUpload"
                  class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                  <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-500">Nhấn để tải ảnh lên</p>
                  </div>
                  <input type="file" id="imageUpload" multiple accept="image/*" class="hidden">
                </label>
              </div>
              <div id="previewImages" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
            <button id="cancelReview"
              class="px-5 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-gray-200 transition-colors">
              Hủy bỏ
            </button>
            <button id="submitReview"
              class="px-5 py-2.5 text-white bg-[#000f8f] rounded-lg hover:bg-[#000e7a] focus:ring-2 focus:ring-blue-300 shadow-md transition-all">
              Gửi đánh giá
            </button>
          </div>
        </div>
      </div>
      <!-- Overlay + Popup form -->
      <div id="full-specs-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6 relative">
          <!-- Nút đóng -->
          <button onclick="toggleFullSpecs()" class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-2xl">
            &times;
          </button>

          <!-- Tiêu đề -->
          <div class="flex items-center bg-blue-900 text-white font-semibold px-4 py-2 rounded-t">
            <i class="ri-settings-3-fill mr-2"></i>
            Thông số kỹ thuật đầy đủ
          </div>

          <!-- Nội dung thông số -->
          <div class="divide-y divide-gray-200">
            <div th:each="spec, iterStat : ${specifications}"
              th:class="${iterStat.index % 2 == 0} ? 'flex bg-white' : 'flex bg-gray-100'">
              <div class="w-1/2 px-4 py-2 font-medium" th:text="${#strings.replace(spec.specKey, '''', '')}"></div>
              <div class="w-1/2 px-4 py-2" th:utext="${#strings.replace(spec.specValue, '\n', '<br/>')}"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Đoạn 3 -->
      <div class="bg-white rounded-lg p-6 mb-6 shadow-[0_0_15px_rgba(0,0,0,0.1)]"
        style="max-width: 1250px; margin: auto">
        <div class="flex items-center justify-between mb-8" style="margin-bottom: 5px">
          <h2 class="text-2xl font-bold border-l-8 border-custom-blue pl-4">
            CÁC SẢN PHẨM LIÊN QUAN
          </h2>
        </div>

        <!-- Sản phẩm khác có thể bạn quan tâm: -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">

          <div th:each="product : ${products}"
            class="bg-white rounded-lg border border-gray-200 shadow-lg hover:shadow-lg transition-all duration-300 group relative overflow-hidden">

            <!-- Mác giảm giá -->
            <div class="absolute top-3 left-3 z-10" th:if="${product.discountedPrice < product.price}">
              <div class="relative">
                <div class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-sm 
                                                transform -rotate-3 origin-left
                                                shadow-[2px_2px_0px_rgba(0,0,0,0.2)] 
                                                group-hover:shadow-[3px_3px_0px_rgba(0,0,0,0.3)]
                                                transition-all duration-200">
                  GIẢM <span th:text="${product.discount}">0</span>%
                </div>
                <!-- Hiệu ứng góc gập 3D */ -->
                <div class="absolute top-full left-1 w-4 h-1 bg-red-700 
                                                transform -rotate-6 origin-top-left
                                                opacity-80"></div>
              </div>
            </div>

            <!-- Hình ảnh sản phẩm -->
            <div class="relative">
              <a th:href="@{/detail/} + ${product.variantID}" class="flex items-center justify-center bg-transparent">
                <img th:if="${product.imagesno2 != null}" th:src="@{'/images/' + ${product.imagesno2}}"
                  alt="Product image"
                  class="w-[200px] mt-7 h-[200px] object-center object-contain transition-transform duration-300 group-hover:scale-110" />
                <img th:unless="${product.imagesno2 != null}" src="https://via.placeholder.com/300x200?text=No+Image"
                  alt="Placeholder image"
                  class="w-[130px] h-auto object-center object-contain transition-transform duration-300 group-hover:scale-110" />
              </a>

              <!-- Wishlist -->
              <div th:action="@{/add}" method="post" class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-md 
             opacity-0 group-hover:opacity-100 transition-all duration-300">
                <button type="button" class="wishlist-toggle w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-md
         opacity-0 group-hover:opacity-100 transition-all duration-300" th:attr="data-variant-id=${product.variantID}">
                  <i th:class="${wishlistIds != null and wishlistIds.contains(product.variantID)} ?
                'ri-heart-fill text-red-600' : 'ri-heart-line text-gray-600 hover:text-red-500'"></i>
                </button>
              </div>

              <!-- Nút giỏ hàng -->
              <button
                class="absolute right-2 bottom-2 w-10 h-10 flex items-center justify-center bg-[#000f8f] text-white rounded-full transform translate-x-full opacity-0 group-hover:translate-x-0 group-hover:opacity-100 transition-all duration-500 ease-in-out hover:bg-red-700 hover:scale-110 z-10"
                th:attr="data-variant-id=${product.variantID}" onclick="addToCart(this)">
                <i class="ri-shopping-cart-line"></i>
              </button>
            </div>

            <!-- Nội dung -->
            <div class="p-4">
              <a th:href="@{/detail/} + ${product.variantID}" class="block">
                <h3
                  class=" h-[70px] font-medium text-gray-800 mb-1 hover:text-yellow-400 transition-colors duration-300"
                  th:text="${product.product.productName} + ' ' + ${product.storage} + ' - Chính hãng VN'">
                </h3>

              </a>

              <div class="flex items-center mb-2">
                <div class="flex text-yellow-400" style="font-size: 18px;">
                  <i class="ri-star-fill ri-xs"></i>
                  <i class="ri-star-fill ri-xs"></i>
                  <i class="ri-star-fill ri-xs"></i>
                  <i class="ri-star-fill ri-xs"></i>
                  <i class="ri-star-fill ri-xs"></i>
                </div>
              </div>

              <div class="flex items-center justify-between">
                <div>
                  <!-- Nếu có giảm -->
                  <span
                    th:if="${product.discountedPrice != null and product.price != null and product.discountedPrice < product.price}"
                    class="flex items-center gap-2">

                    <span class="text-lg font-bold text-red-600"
                      th:text="${#numbers.formatDecimal(product.discountedPrice, 0, 'COMMA', 0, 'POINT') + '₫'}"></span>

                    <span class=" text-gray-500 line-through"
                      style="font-size: 14px; margin-left: 110px; position: absolute;"
                      th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '₫'}"></span>
                  </span>


                  <!-- Nếu không giảm -->
                  <span th:if="${product.discountedPrice == null or product.discountedPrice >= product.price}">
                    <span class="text-lg font-bold text-red-600"
                      th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT') + '₫'}"></span>
                  </span>

                </div>

                <!-- Fallback cho mobile -->
                <button
                  class="w-10 h-10 md:hidden flex items-center justify-center bg-primary text-white rounded-full hover:bg-red-700 transition-all duration-300 transform hover:scale-110">
                  <i class="ri-shopping-cart-line"></i>
                </button>
              </div>

            </div>

            <!-- Overlay hover -->
            <div
              class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-5 transition-all duration-300 pointer-events-none">
            </div>
          </div>

          <!-- Nếu không có sản phẩm -->
          <div th:if="${#lists.isEmpty(products)}" class="w-full text-center py-12 " style="margin-left: 500px;">
            <img
              src="https://i.postimg.cc/nrf4Qjsw/pngtree-business-web-error-404-concept-illustration-png-image-3507632-removebg-preview.png"
              alt="No products" class="mx-auto w-[250px] h-auto   " style="margin-top: -50px;" />
            <p class="text-gray-800 text-lg">Không có sản phẩm nào được tìm thấy.</p>
          </div>


        </div>

        <!-- Nút "Xem tất cả" sẽ dẫn đến trang danh sách sản phẩm khác -->
        <button class="xem-tat-ca-btn" style="margin-top: 20px">
          <a href="/products">Xem toàn bộ sản phẩm</a>
          <i class="arrow-icon fas fa-arrow-right"></i>
        </button>
      </div>


    </div>
  </section>

  <!-- Footer -->
  <div th:insert="views/shared/footer :: footerFragment" style="margin-top: 30px"></div>
</body>

</html>
<script> // JavaScript để xử lý các sự kiện và cập nhật giao diện
  document.addEventListener("DOMContentLoaded", function () {
    // Lấy các phần tử cần thiết
    const mainImage = document.getElementById("main-image");
    const thumbnails = document.querySelectorAll(".thumbnail");
    const colorOptions = document.querySelectorAll('input[name="mausac"]');
    const storageOptions = document.querySelectorAll(".storage-link label");

    // Hàm cập nhật ảnh chính và active thumbnail
    function updateMainImage(imageUrl, altText) {
      // Thêm hiệu ứng fade khi thay đổi ảnh
      mainImage.style.opacity = "0";
      setTimeout(() => {
        mainImage.src = imageUrl;
        mainImage.alt = altText;
        mainImage.style.opacity = "1";
      }, 300);
    }

    // Hàm cập nhật trạng thái active cho các phần tử
    function updateActiveStates(activeElement, elements, activeClass) {
      elements.forEach((element) => {
        if (element === activeElement) {
          element.classList.add(...activeClass.split(" "));
        } else {
          element.classList.remove(...activeClass.split(" "));
        }
      });
    }

    // Xử lý khi click vào thumbnail
    thumbnails.forEach((thumbnail, index) => {
      thumbnail.addEventListener("click", function (e) {
        e.preventDefault();
        const imgElement = this.querySelector("img");
        updateMainImage(imgElement.src, imgElement.alt);

        // Cập nhật trạng thái active cho thumbnail
        updateActiveStates(
          this,
          thumbnails,
          "border-blue-500 ring-2 ring-blue-300"
        );

        // Cập nhật radio button tương ứng
        const colorValue = imgElement.alt;
        const correspondingRadio = Array.from(colorOptions).find(
          (radio) => radio.value === colorValue
        );

        if (correspondingRadio) {
          correspondingRadio.checked = true;
          // Cập nhật UI cho màu sắc
          const colorContainer = correspondingRadio
            .closest("label")
            .querySelector("div");
          updateActiveStates(
            colorContainer,
            Array.from(colorOptions).map((opt) =>
              opt.closest("label").querySelector("div")
            ),
            "border-blue-500 bg-blue-50 ring-2 ring-blue-300"
          );

          // Chuyển trang
          const variantId = correspondingRadio.getAttribute("data-variant-id");
          if (variantId) {
            window.location.href = "/detail/" + variantId;
          }
        }
      });
    });

    // Xử lý khi chọn màu sắc
    colorOptions.forEach((radio) => {
      radio.addEventListener("change", function () {
        if (this.checked) {
          // Cập nhật UI cho màu sắc
          const colorContainer = this.closest("label").querySelector("div");
          updateActiveStates(
            colorContainer,
            Array.from(colorOptions).map((opt) =>
              opt.closest("label").querySelector("div")
            ),
            "border-blue-500 bg-blue-50 ring-2 ring-blue-300"
          );

          // Cập nhật ảnh chính từ thumbnail tương ứng
          const colorValue = this.value;
          const correspondingThumbnail = Array.from(thumbnails).find(
            (thumb) => {
              return thumb.querySelector("img").alt === colorValue;
            }
          );

          if (correspondingThumbnail) {
            const imgElement = correspondingThumbnail.querySelector("img");
            updateMainImage(imgElement.src, imgElement.alt);
            updateActiveStates(
              correspondingThumbnail,
              thumbnails,
              "border-blue-500 ring-2 ring-blue-300"
            );
          }

          // Chuyển trang
          const variantId = this.getAttribute("data-variant-id");
          if (variantId) {
            window.location.href = "/detail/" + variantId;
          }
        }
      });
    });

    // Khởi tạo trạng thái ban đầu
    function initializeActiveStates() {
      // Tìm màu sắc đang được chọn
      const activeRadio = Array.from(colorOptions).find(
        (radio) => radio.checked
      );
      if (activeRadio) {
        const colorContainer = activeRadio
          .closest("label")
          .querySelector("div");
        colorContainer.classList.add(
          "border-blue-500",
          "bg-blue-50",
          "ring-2",
          "ring-blue-300"
        );

        // Tìm thumbnail tương ứng
        const colorValue = activeRadio.value;
        const activeThumbnail = Array.from(thumbnails).find((thumb) => {
          return thumb.querySelector("img").alt === colorValue;
        });

        if (activeThumbnail) {
          activeThumbnail.classList.add(
            "border-blue-500",
            "ring-2",
            "ring-blue-300"
          );
        }
      }

      // Storage options đã được xử lý bằng Thymeleaf
    }
    initializeActiveStates();

    // Xử lý tăng giảm số lượng sản phẩm
    // const minusBtn = document.querySelector(".quantity-btn.minus");
    // const plusBtn = document.querySelector(".quantity-btn.plus");
    // const quantityInput = document.querySelector(".quantity-input");

    // if (minusBtn && plusBtn && quantityInput) {
    //   minusBtn.addEventListener("click", function () {
    //     let value = parseInt(quantityInput.value);
    //     if (value > 1) {
    //       quantityInput.value = value - 1;
    //     }
    //   });

    //   plusBtn.addEventListener("click", function () {
    //     let value = parseInt(quantityInput.value);
    //     if (value < 99) {
    //       quantityInput.value = value + 1;
    //     }
    //   });

    //   quantityInput.addEventListener("change", function () {
    //     let value = parseInt(this.value);
    //     if (isNaN(value) || value < 1) {
    //       this.value = 1;
    //     } else if (value > 99) {
    //       this.value = 99;
    //     }
    //   });
    // }

    // Hiệu ứng cuộn cho phần hình ảnh sản phẩm
    const scrollableSection = document.querySelector(
      ".product-images-scrollable"
    );
    if (scrollableSection) {
      const scrollLimit = 450;

      window.addEventListener("scroll", function () {
        if (window.innerWidth >= 1024) {
          const scrollPosition = window.scrollY || window.pageYOffset;
          const translateY = Math.min(scrollPosition, scrollLimit);
          scrollableSection.style.transform = `translateY(${translateY}px)`;

          if (scrollPosition >= scrollLimit) {
            document.body.classList.add("scrolled");
          } else {
            document.body.classList.remove("scrolled");
          }
        }
      });
    }

    // Xử lý sự kiện click cho các nút bộ lọc
    const buttons = document.querySelectorAll(".filter-button");
    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        buttons.forEach((btn) =>
          btn.classList.remove("border-blue-600", "font-semibold")
        );
        button.classList.add("border-blue-600", "font-semibold");
      });
    });
  });

  // Hàm hiển thị thông số kỹ thuật đầy đủ
  function toggleFullSpecs() {
    const modal = document.getElementById("full-specs-modal");
    if (modal) {
      modal.classList.toggle("hidden");
    }
  }
</script>
<script> // Hiệu ứng cuộn cho phần hình ảnh sản phẩm
  document.addEventListener('DOMContentLoaded', function () {
    const scrollableSection = document.querySelector('.product-images-scrollable');
    const scrollLimit = 400; // Giới hạn 200px

    window.addEventListener('scroll', function () {
      if (window.innerWidth >= 1024) {
        const scrollPosition = window.scrollY || window.pageYOffset;
        const translateY = Math.min(scrollPosition, scrollLimit);

        scrollableSection.style.transform = `translateY(${translateY}px)`;

        // Thêm class khi đạt giới hạn
        if (scrollPosition >= scrollLimit) {
          document.body.classList.add('scrolled');
        } else {
          document.body.classList.remove('scrolled');
        }
      }
    });
  });
</script>
<script> // Xử lý sự kiện click cho nút wishlist
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.wishlist-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const variantId = this.getAttribute('data-variant-id');
        const userId = this.getAttribute('data-user-id');

        if (!userId) {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
          return;
        }

        fetch(`/api/wishlist/toggle?userId=${userId}&productVariantId=${variantId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const icon = this.querySelector('i');
              if (data.added) {
                icon.classList.replace('ri-heart-line', 'ri-heart-fill');
                icon.classList.replace('text-gray-600', 'text-red-500');
                this.classList.add('active');
              } else {
                icon.classList.replace('ri-heart-fill', 'ri-heart-line');
                icon.classList.replace('text-red-500', 'text-gray-600');
                this.classList.remove('active');
              }
            }
          })
          .catch(error => console.error('Error:', error));
      });
    });
  });
</script>

<script> // Xử lý sự kiện tăng giảm số lượng sản phẩm
  document.addEventListener("DOMContentLoaded", function () {
    const qtyInput = document.getElementById("quantity");
    const decreaseBtn = document.getElementById("decreaseQty");
    const increaseBtn = document.getElementById("increaseQty");

    decreaseBtn.addEventListener("click", () => {
      let qty = parseInt(qtyInput.value);
      if (qty > 1) qtyInput.value = qty - 1;
    });

    increaseBtn.addEventListener("click", () => {
      let qty = parseInt(qtyInput.value);
      if (qty < 99) qtyInput.value = qty + 1;
    });

    qtyInput.addEventListener("change", function () {
      let value = parseInt(this.value);
      if (isNaN(value) || value < 1) {
        this.value = 1;
      } else if (value > 99) {
        this.value = 99;
      }
    });
  });
</script>

<script> // danh gia va binh luan
  document.addEventListener("DOMContentLoaded", function () {
    const qtyInput = document.getElementById("quantity");
    const decreaseBtn = document.getElementById("decreaseQty");
    const increaseBtn = document.getElementById("increaseQty");

    decreaseBtn.addEventListener("click", () => {
      let qty = parseInt(qtyInput.value);
      if (qty > 1) qtyInput.value = qty - 1;
    });

    increaseBtn.addEventListener("click", () => {
      let qty = parseInt(qtyInput.value);
      if (qty < 99) qtyInput.value = qty + 1;
    });

    qtyInput.addEventListener("change", function () {
      let value = parseInt(this.value);
      if (isNaN(value) || value < 1) {
        this.value = 1;
      } else if (value > 99) {
        this.value = 99;
      }
    });
  });
</script>

<script th:inline="javascript"> // Xử lý sự kiên đánh giá và bình luận 
  /* === Review & Feedback unified script ===
     Place this inside the Thymeleaf .html (so Thymeleaf can render productId).
     Assumptions:
      - Backend endpoints:
         GET  /api/reviews/product/{productId}            -> list reviews (optional ?rating=)
         POST /api/reviews                                -> create review (FormData: productId, rating, comment, images[])
         GET  /api/reviews/{reviewId}/feedback            -> list replies/feedback
         POST /api/reviews/{reviewId}/feedback           -> create reply (x-www-form-urlencoded: content)
         GET  /api/reviews/{reviewId}/like-count         -> { count: n }
         GET  /api/reviews/{reviewId}/has-liked          -> { hasLiked: true|false }  (credentials: include)
         POST /api/reviews/{reviewId}/like               -> toggle like (credentials: include)
         GET  /api/reviews/stats/{productId}             -> { averageRating, totalReviews, ratingCounts: { '5star':n,... } }
         GET  /api/reviews/check-auth                    -> { username } when logged in (credentials: include)
      - Responses are JSON.
  */

  const PRODUCT_ID = /*[[${v.product.productID}]]*/ 0; // Thymeleaf will replace this
  console.log('Initializing reviews script for productId:', PRODUCT_ID);

  document.addEventListener('DOMContentLoaded', function () {
    let currentUser = null;
    let currentFilter = 0; // 0 => all

    // --- Helper: check login ---
    async function checkLoginStatus() {
      try {
        const resp = await fetch('/api/reviews/check-auth', { credentials: 'include' });
        if (!resp.ok) { currentUser = null; return false; }
        const data = await resp.json();
        currentUser = data.username || null;
        return !!currentUser;
      } catch (e) {
        currentUser = null;
        return false;
      }
    }

    // --- Load reviews (optionally filter by rating) ---
    async function loadReviews(productId, rating = null) {
      const container = document.getElementById('reviews-container');
      if (!container) return;
      container.innerHTML = `<div class="py-4 text-center">Đang tải...</div>`;

      try {
        let url = `/api/reviews/product/${productId}`;
        if (rating && rating > 0) url += `?rating=${rating}`;

        const resp = await fetch(url);
        const text = await resp.text(); // read raw text first
        if (!resp.ok) {
          // show server returned error body
          throw new Error(text || 'Failed to load reviews');
        }

        let reviews;
        try {
          reviews = JSON.parse(text); // robust parse, and will throw if invalid
        } catch (parseErr) {
          console.error('Invalid JSON from server. Raw response text:', text);
          throw new Error('Invalid JSON from server: ' + parseErr.message);
        }

        if (!Array.isArray(reviews) || reviews.length === 0) {
          container.innerHTML = `
      <div class="text-center py-4" style="margin-bottom:70px;margin-top:120px">
        ${rating ? `Chưa có đánh giá ${rating} sao nào` : 'Chưa có đánh giá nào cho sản phẩm này'}
      </div>`;
          return;
        }

        container.innerHTML = '';
        for (const review of reviews) {
          const el = await createReviewElement(review);
          container.appendChild(el);
        }
      } catch (err) {
        console.error('Error loading reviews:', err);
        container.innerHTML = `<div class="text-center py-4 text-red-500">Đã xảy ra lỗi khi tải đánh giá: ${err.message}</div>`;
      }
    }

    // --- Create review DOM ---
    async function createReviewElement(review) {
      const wrapper = document.createElement('div');
      wrapper.className = 'border-t border-gray-200 pt-4 pb-4';
      wrapper.dataset.reviewId = review.id;

      const dateText = review.createdAt ? new Date(review.createdAt).toLocaleString('vi-VN') : 'Không rõ ngày';

      const starsHtml = Array.from({ length: 5 }).map((_, i) =>
        `<i class="fa-solid ${i < review.rating ? 'text-yellow-500' : 'text-gray-300'} fa-star mr-1"></i>`
      ).join('');

      let imagesHtml = '';
      if (review.images) {
        // If backend returns comma-separated URLs or array; handle both
        const urls = Array.isArray(review.images) ? review.images : ('' + review.images).split(',').filter(u => u);
        if (urls.length) {
          imagesHtml = `<div class="flex flex-wrap mt-2">${urls.map(u => `<img src="${u}" class="h-20 object-cover mr-2 mb-2 rounded cursor-pointer" onclick="window.open('${u}','_blank')">`).join('')}</div>`;
        }
      }

      // Build base HTML
      wrapper.innerHTML = `
      <div class="flex justify-between items-start">
        <p class="font-semibold">${escapeHtml(review.username) || 'Ẩn danh'}</p>
        <span class="text-sm text-gray-500">${dateText}</span>
      </div>
      <div class="flex items-center mb-1 mt-2">
        <div class="text-yellow-500 mr-2">${starsHtml}</div>
      </div>
      <p class="text-gray-800 mb-2">${escapeHtml(review.comment || '')}</p>
      ${imagesHtml}
      <div class="flex items-center justify-between mt-3">
        <div class="flex gap-4 text-xs text-gray-500">
          <a href="#" class="hover:underline reply-link">Trả lời</a>
          <button class="like-button hover:underline flex items-center gap-1 ${review.hasLiked ? 'text-blue-500' : ''}" data-review-id="${review.id}">
            <i class="${review.hasLiked ? 'fa-solid' : 'fa-regular'} fa-thumbs-up"></i>
            <span class="like-count">0</span>
          </button>
        </div>
      </div>

      <div class="reply-modal hidden mt-3 pl-4 border-l-2 border-gray-200">
        <textarea class="w-full px-3 py-2 border rounded-md reply-input" rows="2" placeholder="Viết phản hồi của bạn..."></textarea>
        <div class="flex justify-end gap-2 mt-2">
          <button class="px-3 py-1 bg-gray-200 rounded-md cancel-reply">Hủy</button>
          <button class="px-3 py-1 bg-blue-500 text-white rounded-md submit-reply">Gửi</button>
        </div>
      </div>

      <div class="feedback-list mt-3 pl-4 border-l-2 border-gray-200"></div>
    `;

      // After insert, update like count & hasLiked by fetching endpoints (non-blocking)
      fetchLikeCount(review.id, wrapper.querySelector('.like-count'));
      // If API supports has-liked, update icon (we fetched hasLiked earlier possibly)
      if (currentUser) {
        try {
          const resp = await fetch(`/api/reviews/${review.id}/has-liked`, { credentials: 'include' });
          if (resp.ok) {
            const d = await resp.json();
            if (d.hasLiked) {
              const btn = wrapper.querySelector('.like-button');
              if (btn) {
                btn.classList.add('text-blue-500');
                const icon = btn.querySelector('i');
                if (icon) { icon.classList.remove('fa-regular'); icon.classList.add('fa-solid'); }
              }
            }
          }
        } catch (e) { }
      }

      // Load feedback list
      const feedbackList = wrapper.querySelector('.feedback-list');
      loadFeedback(review.id, feedbackList);

      // Setup handlers
      setupReviewEventHandlers(wrapper);

      return wrapper;
    }

    // --- Escape HTML to prevent injection ---
    function escapeHtml(unsafe) {
      return String(unsafe || '').replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;',
          "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
        })[s];
      });
    }

    // --- Fetch like count ---
    async function fetchLikeCount(reviewId, el) {
      if (!el) return;
      try {
        const resp = await fetch(`/api/reviews/${reviewId}/like-count`);
        if (!resp.ok) return;
        const d = await resp.json();
        el.textContent = d.count || 0;
      } catch (e) { console.error('Like count error', e); }
    }

    // --- Setup event handlers for a review element ---
    function setupReviewEventHandlers(reviewElement) {
      // Reply link toggle
      const replyLink = reviewElement.querySelector('.reply-link');
      if (replyLink) {
        replyLink.addEventListener('click', async function (e) {
          e.preventDefault();
          const logged = await checkLoginStatus();
          if (!logged) {
            Swal.fire({ icon: 'info', title: 'Thông báo', text: 'Vui lòng đăng nhập để gửi phản hồi', confirmButtonText: 'OK' });
            return;
          }
          const modal = reviewElement.querySelector('.reply-modal');
          // hide others
          document.querySelectorAll('.reply-modal').forEach(m => { if (m !== modal) m.classList.add('hidden'); });
          modal.classList.toggle('hidden');
          if (!modal.classList.contains('hidden')) modal.querySelector('.reply-input').focus();
        });
      }

      // Cancel reply
      const cancelBtn = reviewElement.querySelector('.cancel-reply');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function () {
          const modal = this.closest('.reply-modal');
          modal.classList.add('hidden');
          modal.querySelector('.reply-input').value = '';
        });
      }

      // Submit reply
      const submitReply = reviewElement.querySelector('.submit-reply');
      if (submitReply) {
        submitReply.addEventListener('click', async function () {
          const logged = await checkLoginStatus();
          if (!logged) { alert('Phiên đăng nhập đã hết hạn, vui lòng đăng nhập lại'); return; }

          const modal = this.closest('.reply-modal');
          const content = modal.querySelector('.reply-input').value.trim();
          if (!content) { alert('Vui lòng nhập nội dung phản hồi'); return; }

          const reviewId = reviewElement.dataset.reviewId;
          try {
            const resp = await fetch(`/api/reviews/${reviewId}/feedback`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: `content=${encodeURIComponent(content)}`,
              credentials: 'include'
            });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Lỗi server' }));
              throw new Error(err.error || 'Error submitting feedback');
            }
            modal.querySelector('.reply-input').value = '';
            modal.classList.add('hidden');
            // reload feedback
            const feedbackList = reviewElement.querySelector('.feedback-list');
            loadFeedback(reviewId, feedbackList);
          } catch (e) {
            console.error('Submit feedback error', e);
            alert('Có lỗi khi gửi phản hồi: ' + e.message);
          }
        });
      }

      // Like / unlike
      // Like / unlike
      const likeBtn = reviewElement.querySelector('.like-button');
      if (likeBtn) {
        likeBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          const logged = await checkLoginStatus();
          if (!logged) {
            Swal.fire({ icon: 'info', title: 'Thông báo', text: 'Vui lòng đăng nhập để thích đánh giá' });
            return;
          }

          const reviewId = this.dataset.reviewId;
          const icon = this.querySelector('i');
          const countEl = this.querySelector('.like-count');
          let count = parseInt(countEl.textContent || '0');

          if (icon.classList.contains('fa-solid')) {
            // Đã like rồi -> hỏi xác nhận trước khi bỏ like
            const confirm = await Swal.fire({
              title: 'Xác nhận',
              text: 'Bạn có chắc chắn bỏ like không?',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'Có',
              cancelButtonText: 'Không'
            });
            if (!confirm.isConfirmed) return;
          }

          try {
            const resp = await fetch(`/api/reviews/${reviewId}/like`, {
              method: 'POST',
              credentials: 'include'
            });
            if (!resp.ok) {
              const err = await resp.json().catch(() => ({ error: 'Lỗi' }));
              throw new Error(err.error || 'Error liking review');
            }

            const result = await resp.json();

            if (result.message === "liked") {
              icon.classList.remove('fa-regular');
              icon.classList.add('fa-solid');
              this.classList.add('text-blue-500');
              count++;
            } else if (result.message === "unliked") {
              icon.classList.remove('fa-solid');
              icon.classList.add('fa-regular');
              this.classList.remove('text-blue-500');
              count = Math.max(0, count - 1);
            }
            countEl.textContent = count;
          } catch (e) {
            console.error('Like error', e);
            Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Có lỗi khi xử lý like: ' + e.message });
          }
        });
      }

    }

    // --- Load feedback for a review ---
    async function loadFeedback(reviewId, container) {
      if (!container) return;
      container.innerHTML = `<div class="text-sm text-gray-500 py-2">Đang tải phản hồi...</div>`;
      try {
        const resp = await fetch(`/api/reviews/${reviewId}/feedback`);
        if (!resp.ok) throw new Error('Failed to load feedback');
        const feedbacks = await resp.json();
        if (!Array.isArray(feedbacks) || feedbacks.length === 0) {
          container.innerHTML = '';
          return;
        }
        container.innerHTML = '';
        for (const f of feedbacks) {
          const el = document.createElement('div');
          el.className = 'mb-3 pb-2 border-b border-gray-100 last:border-0';
          const date = f.createdAt ? new Date(f.createdAt).toLocaleString('vi-VN') : 'Không rõ ngày';
          el.innerHTML = `<div class="flex justify-between items-start">
                          <p class="font-semibold text-sm">${escapeHtml(f.username) || 'Ẩn danh'}</p>
                          <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-gray-800 text-sm mt-1">${escapeHtml(f.content || '')}</p>`;
          container.appendChild(el);
        }
      } catch (e) {
        console.error('Load feedback error', e);
        container.innerHTML = `<p class="text-red-500 text-sm">Đã xảy ra lỗi khi tải phản hồi</p>`;
      }
    }

    // --- Update review stats (average, totals) ---
    async function updateReviewStats(productId) {
      try {
        const resp = await fetch(`/api/reviews/stats/${productId}`);
        if (!resp.ok) return;
        const stats = await resp.json();
        const avgEl = document.getElementById('average-rating');
        if (avgEl && typeof stats.averageRating === 'number') avgEl.textContent = `${stats.averageRating.toFixed(1)}/5`;

        const starsContainer = document.getElementById('average-stars');
        if (starsContainer) {
          starsContainer.innerHTML = '';
          const avgRounded = Math.round(stats.averageRating || 0);
          for (let i = 1; i <= 5; i++) {
            const iEl = document.createElement('i');
            iEl.className = `fa-solid fa-star ${i <= avgRounded ? 'text-yellow-500' : 'text-gray-300'} mr-1`;
            starsContainer.appendChild(iEl);
          }
        }

        const totalEl = document.getElementById('total-reviews');
        if (totalEl) totalEl.textContent = `(${stats.totalReviews || 0} đánh giá)`;

        // Update filter button text if ratingCounts provided
        if (stats.ratingCounts) {
          document.querySelectorAll('.filter-button').forEach(btn => {
            const rating = parseInt(btn.getAttribute('data-rating')) || 0;
            if (rating === 0) {
              btn.textContent = `Tất cả (${stats.totalReviews || 0})`;
            } else {
              // ratingCounts keys could be numbers or strings - be resilient
              const count = stats.ratingCounts[String(rating)] ?? stats.ratingCounts[rating] ?? 0;
              btn.textContent = `${rating} sao (${count})`;
            }
          });
        }
      } catch (e) {
        console.error('Update stats error', e);
      }
    }

    // --- Review modal UI (open/close), star selection, image preview, submit review ---
    // Open modal (requires #openReviewModal & #reviewModal elements)
    const openBtn = document.getElementById('openReviewModal');
    if (openBtn) {
      openBtn.addEventListener('click', async () => {
        const logged = await checkLoginStatus();
        if (!logged) {
          Swal.fire({ icon: 'warning', title: 'Thông báo', text: 'Vui lòng đăng nhập để đánh giá sản phẩm', confirmButtonText: 'OK' });
          return;
        }
        const modal = document.getElementById('reviewModal');
        if (modal) modal.classList.remove('hidden');
      });
    }

    // Cancel button
    const cancelBtn = document.getElementById('cancelReview');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        const modal = document.getElementById('reviewModal');
        if (modal) modal.classList.add('hidden');
        resetReviewForm();
      });
    }

    // Star selection
    const starEls = document.querySelectorAll('.rating-stars i');
    starEls.forEach((s, idx) => {
      s.addEventListener('click', () => {
        const value = parseInt(s.getAttribute('data-value')) || (idx + 1);
        const input = document.getElementById('ratingValue');
        if (input) input.value = value;
        starEls.forEach((el, i) => {
          if (i < value) { el.classList.remove('fa-regular'); el.classList.add('fa-solid', 'text-yellow-500'); }
          else { el.classList.remove('fa-solid', 'text-yellow-500'); el.classList.add('fa-regular'); }
        });
      });
    });

    // Image preview
    const imgInput = document.getElementById('imageUpload');
    if (imgInput) {
      imgInput.addEventListener('change', function (e) {
        const preview = document.getElementById('previewImages');
        preview.innerHTML = '';
        Array.from(e.target.files).slice(0, 5).forEach(file => {
          if (!file.type.startsWith('image/')) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            const img = document.createElement('img');
            img.src = ev.target.result;
            img.className = 'h-20 object-cover mr-2 mb-2 rounded';
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });
    }

    // Submit review
    const submitBtn = document.getElementById('submitReview');
    if (submitBtn) {
      submitBtn.addEventListener('click', async () => {
        const logged = await checkLoginStatus();
        if (!logged) { Swal.fire({ icon: 'info', title: 'Thông báo', text: 'Phiên đăng nhập đã hết hạn, vui lòng đăng nhập lại' }); return; }

        const rating = document.getElementById('ratingValue')?.value || '0';
        const comment = document.getElementById('reviewComment')?.value || '';
        const imageFiles = document.getElementById('imageUpload')?.files || [];

        if (rating === '0' || Number(rating) <= 0) {
          Swal.fire({ icon: 'warning', title: 'Chưa chọn đánh giá', text: 'Vui lòng chọn số sao đánh giá trước khi gửi' });
          return;
        }
        if (!comment.trim()) {
          Swal.fire({ icon: 'warning', title: 'Thiếu nội dung', text: 'Vui lòng nhập bình luận' });
          return;
        }

        // Build FormData and send
        const fd = new FormData();
        fd.append('productId', PRODUCT_ID);
        fd.append('rating', rating);
        fd.append('comment', comment);
        if (imageFiles.length) {
          Array.from(imageFiles).slice(0, 5).forEach(f => fd.append('images', f));
        }

        try {
          const resp = await fetch('/api/reviews', {
            method: 'POST',
            body: fd,
            credentials: 'include'
          });
          if (!resp.ok) {
            // try to read JSON error, else text
            const err = await resp.json().catch(() => null);
            throw new Error((err && (err.error || err.message)) || await resp.text() || 'Error submitting review');
          }

          Swal.fire({ icon: 'success', title: 'Thành công', text: 'Đánh giá của bạn đã được gửi!', confirmButtonText: 'OK' });
          document.getElementById('reviewModal')?.classList.add('hidden');
          resetReviewForm();
          // reload lists & stats
          loadReviews(PRODUCT_ID, currentFilter);
          updateReviewStats(PRODUCT_ID);
        } catch (e) {
          console.error('Submit review error', e);
          Swal.fire({ icon: 'error', title: 'Lỗi', text: 'Có lỗi xảy ra khi gửi đánh giá: ' + e.message });
        }
      });
    }

    // Reset review form
    function resetReviewForm() {
      document.getElementById('reviewComment') && (document.getElementById('reviewComment').value = '');
      document.getElementById('imageUpload') && (document.getElementById('imageUpload').value = '');
      document.getElementById('previewImages') && (document.getElementById('previewImages').innerHTML = '');
      document.getElementById('ratingValue') && (document.getElementById('ratingValue').value = 0);
      document.querySelectorAll('.rating-stars i').forEach(i => { i.classList.remove('fa-solid', 'text-yellow-500'); i.classList.add('fa-regular'); });
    }

    // Filter buttons (assumes .filter-button elements exist and have data-rating attribute)
    document.querySelectorAll('.filter-button').forEach(btn => {
      btn.addEventListener('click', function () {
        const rating = parseInt(this.getAttribute('data-rating')) || 0;
        currentFilter = rating;
        // active style
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('bg-gray-200', 'border-gray-500', 'active-filter'));
        this.classList.add('bg-gray-200', 'border-gray-500', 'active-filter');
        loadReviews(PRODUCT_ID, rating);
      });
    });

    // Initial load
    (async () => {
      await checkLoginStatus();
      loadReviews(PRODUCT_ID, currentFilter);
      updateReviewStats(PRODUCT_ID);
    })();

  }); // DOMContentLoaded
</script>