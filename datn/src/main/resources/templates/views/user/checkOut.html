<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh toán</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <!-- Font Awesome CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      #full-address {
        overflow-y: auto;
        height: auto;
        min-height: 40px;
        max-height: 120px;
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen">
    <header class="bg-white">
      <div class="max-w-7xl mx-auto py-4 flex justify-center">
        <img
          src="https://i.postimg.cc/MHPrfMBt/Screenshot-2025-06-19-212641.png"
          alt="Logo"
          class="h-21 object-contain"
          style="margin-bottom: -80px"
        />
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left Column - Shipping Info -->
        <!-- Font Awesome nếu cần -->
        <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        />

        <style>
          .form-group {
            position: relative;
          }

          .form-input {
            width: 100%;
            padding: 1rem 0.75rem 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
          }

          .form-label {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            font-size: 0.875rem;
            color: #6b7280;
            transition: all 0.2s ease-out;
            pointer-events: none;
          }

          .form-input:focus + .form-label,
          .form-input:not(:placeholder-shown) + .form-label {
            top: 0.25rem;
            left: 0.75rem;
            font-size: 0.75rem;
            background-color: white;
            padding: 0 0.25rem;
            color: #2563eb;
          }
        </style>
        <!-- <-- Left Column - Payment -->
        <div class="lg:w-[400px]">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h1 class="text-2xl font-semibold text-gray-800 mb-6">
              Thông tin nhận hàng
            </h1>
            <form id="checkout-form" class="space-y-4" style="margin-top: -5px">
              <!-- Email -->
              <div class="form-group">
                <input
                  type="email"
                  id="email"
                  name="email"
                  class="form-input"
                  placeholder=" "
                  th:value="${email}"
                  readonly
                />
                <label for="email" class="form-label">Email</label>
              </div>

              <!-- Họ và tên -->
              <div class="form-group">
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-input"
                  placeholder=" "
                  th:value="${name}"
                  readonly
                />
                <label for="name" class="form-label">Họ và tên</label>
              </div>

              <!-- Số điện thoại -->
              <div class="form-group flex-1">
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  class="form-input"
                  placeholder=" "
                  th:value="${phone}"
                  readonly
                />
                <label for="phone" class="form-label">Số điện thoại</label>
              </div>

              <!-- Địa chỉ: Tỉnh/Thành phố, Quận/Huyện, Phường/Xã -->
              <div class="grid grid-cols-2 gap-4">
                <!-- Tỉnh/Thành phố -->
                <div class="relative">
                  <select
                    id="province"
                    name="province"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md appearance-none"
                  >
                    <option value="">Chọn Tỉnh/TP</option>
                  </select>
                  <div
                    class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </div>
                </div>

                <!-- Quận/Huyện -->
                <div class="relative">
                  <select
                    id="district"
                    name="district"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md appearance-none"
                  >
                    <option value="">Chọn Quận/Huyện</option>
                  </select>
                  <div
                    class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Phường/Xã -->
              <div class="relative mt-4">
                <select
                  id="ward"
                  name="ward"
                  class="w-full px-4 py-2 border border-gray-300 rounded-md appearance-none"
                >
                  <option value="">Chọn Phường/Xã</option>
                </select>
                <div
                  class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </div>
              <!-- Địa chỉ -->
              <div class="form-group">
                <input
                  type="text"
                  id="address"
                  name="address"
                  class="form-input"
                  placeholder=" "
                />
                <label for="address" class="form-label">Địa chỉ</label>
              </div>

              <!-- Ghi chú -->
              <div class="form-group">
                <textarea
                  type="hidden"
                  id="note"
                  name="note"
                  rows="3"
                  class="form-input resize-none"
                  placeholder=" "
                ></textarea>
                <label for="note" class="form-label">Ghi chú về đơn hàng</label>
              </div>
              <div class="form-group">
                <textarea
                  type="hidden"
                  id="full-address"
                  name="full-address"
                  class="form-input bg-gray-100 cursor-not-allowed resize-none"
                  placeholder="Địa chỉ đầy đủ"
                  rows="2"
                  readonly
                ></textarea>
              </div>
            </form>
          </div>
        </div>

        <!-- Middle Column - Payment -->
        <div class="lg:w-[400px]">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="mb-8">
              <h2 class="text-2xl font-semibold text-gray-900 mb-4">
                Thanh toán
              </h2>
              <div class="space-y-3">
                <label
                  class="flex items-center justify-between p-4 border border-gray-200 rounded-lg cursor-pointer"
                >
                  <div class="flex items-center w-full justify-between">
                    <div class="flex items-center">
                      <input
                        type="radio"
                        name="payment"
                        class="text-blue-500"
                        id="bank-payment"
                        checked
                      />
                      <span class="ml-2">Chuyển khoản</span>
                    </div>
                    <i class="fa-solid fa-building-columns text-blue-500"></i>
                  </div>
                </label>
                <label
                  class="flex items-center justify-between p-4 border border-gray-200 rounded-lg cursor-pointer"
                >
                  <div class="flex items-center w-full justify-between">
                    <div class="flex items-center">
                      <input
                        type="radio"
                        name="payment"
                        class="text-blue-500"
                        id="cod-payment"
                      />
                      <span class="ml-2">Thanh toán khi nhận hàng (COD)</span>
                    </div>
                    <i class="fa-solid fa-money-bill-wave text-green-500"></i>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Order Summary -->
        <div class="lg:w-[400px]" id="bank-section">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h2
              class="flex items-center text-2xl font-semibold text-gray-900 mb-4"
            >
              Đơn hàng
              <span
                class="ml-2 text-lg font-normal text-gray-900"
                th:text="'(' + ${#lists.size(cartItems)} + ' sản phẩm)'"
              ></span>
            </h2>

            <!-- sản phẩm -->
            <div class="border-t border-b border-gray-250 py-4">
              <div class="space-y-4">
                <!-- Danh sách sản phẩm -->
                <div
                  th:each="cart : ${cartItems}"
                  class="flex items-start pb-4 border-b border-gray-250"
                >
                  <div class="relative">
                    <img
                      th:src="@{'/images/' + ${cart.variant.imagesno2}}"
                      th:alt="${cart.variant.product.productName}"
                      class="w-15 h-20 rounded-lg"
                    />

                    <div
                      class="absolute -top-2 -left-2 bg-blue-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center"
                    >
                      <span th:text="${cart.quantity}">1</span>
                    </div>
                  </div>
                  <div class="ml-4 flex-1 min-w-0">
                    <h3
                      class="text-sm font-medium text-gray-900 mb-1 break-words"
                    >
                      <span th:text="${cart.variant.product.productName}"
                        >iPhone 14 128GB</span
                      >
                      <span
                        th:if="${cart.variant.storage != null}"
                        th:text="' - ' + ${cart.variant.storage}"
                      >
                        - Chính hãng VN/A</span
                      >
                    </h3>
                    <div class="flex justify-between items-center">
                      <p
                        class="text-sm text-gray-500"
                        th:text="${cart.variant.color} ?: ''"
                      >
                        Trắng
                      </p>
                      <p class="text-sm font-semibold text-blue-600">
                        <span
                          th:if="${cart.variant.discountedPrice != null}"
                          th:text="${#numbers.formatDecimal(cart.variant.discountedPrice, 1, 'COMMA', 0, 'POINT') + '₫'}"
                        >
                          15.990.000₫
                        </span>
                        <span
                          th:unless="${cart.variant.discountedPrice != null}"
                          th:text="${#numbers.formatDecimal(cart.variant.price, 1, 'COMMA', 0, 'POINT') + '₫'}"
                        >
                          15.990.000₫
                        </span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mã giảm giá -->
            <div class="mt-4">
              <form method="get" action="/checkout" class="flex items-center">
                <input
                  type="text"
                  name="voucherCode"
                  placeholder="Nhập mã giảm giá"
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md text-sm"
                  th:value="${voucherCode}"
                />
                <button
                  type="submit"
                  class="px-6 py-2 bg-blue-500 text-white rounded-r-md text-sm font-medium hover:bg-yellow-500"
                >
                  Áp dụng
                </button>
              </form>

              <p
                th:if="${voucherError}"
                class="text-red-600 text-sm mt-2"
                th:text="${voucherError}"
              ></p>
            </div>

            <!-- Giá -->
            <div class="mt-6 space-y-2 text-sm text-gray-700">
              <div class="flex justify-between">
                <span>Tạm tính</span>
                <span
                  class="font-medium"
                  th:text="${#numbers.formatDecimal(originalTotal, 1, 'COMMA', 0, 'POINT') + '₫'}"
                >
                  15.900.000₫
                </span>
              </div>

              <!-- Nếu có giảm giá -->
              <div
                class="flex justify-between"
                th:if="${discountAmount != null}"
              >
                <span>Giảm giá</span>
                <span
                  class="font-medium text-green-600"
                  th:text="'- ' + ${#numbers.formatDecimal(discountAmount, 1, 'COMMA', 0, 'POINT') + '₫'}"
                >
                  - 20.000₫
                </span>
              </div>

              <div class="flex justify-between">
                <span>Phí vận chuyển</span>
                <span class="font-medium">0₫</span>
                <!-- Có thể thay bằng giá vận chuyển thực tế -->
              </div>
              <div
                class="flex justify-between text-base font-semibold text-gray-900 pt-4 border-t border-gray-200"
              >
                <span>Tổng cộng</span>
                <span
                  style="font-size: 22px; font-weight: 700; color: #000f8f"
                  th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 0, 'POINT') + '₫'}"
                >
                  15.900.000₫
                </span>
              </div>
            </div>

            <!-- đặt hàng -->
            <div class="mt-6">
              <button
                id="vnpay-button"
                type="button"
                class="block text-center w-full px-6 py-3 bg-blue-500 text-white rounded-md font-medium hover:bg-yellow-500 transition-colors duration-300"
              >
                ĐẶT HÀNG
              </button>

              <a
                href="cart"
                class="group flex items-center justify-center text-sm text-blue-500 hover:text-yellow-500 mt-4 transition-colors duration-300"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4 mr-2 transform transition-transform duration-300 group-hover:-translate-x-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 19l-7-7m0 0l7-7m-7 7h18"
                  />
                </svg>
                <span class="">Quay về giỏ hàng</span>
              </a>
            </div>
          </div>
        </div>
        <div class="lg:w-[400px] hidden" id="cod-section">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-2xl font-semibold text-gray-900 mb-4">
              Đặt hàng COD
              <span
                class="ml-2 text-lg font-normal text-gray-900"
                th:text="'(' + ${#lists.size(cartItems)} + ' sản phẩm)'"
              ></span>
            </h2>

            <p class="text-sm mb-4">
              Bạn sẽ thanh toán khi nhận hàng tại địa chỉ đã chọn.
            </p>
            <!-- sản phẩm -->
            <div class="border-t border-b border-gray-250 py-4">
              <div class="space-y-4">
                <!-- Danh sách sản phẩm -->
                <div
                  th:each="cart : ${cartItems}"
                  class="flex items-start pb-4 border-b border-gray-250"
                >
                  <div class="relative">
                    <img
                      th:src="@{'/images/' + ${cart.variant.imagesno2}}"
                      th:alt="${cart.variant.product.productName}"
                      class="w-15 h-20 rounded-lg"
                    />

                    <div
                      class="absolute -top-2 -left-2 bg-blue-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center"
                    >
                      <span th:text="${cart.quantity}">1</span>
                    </div>
                  </div>
                  <div class="ml-4 flex-1 min-w-0">
                    <h3
                      class="text-sm font-medium text-gray-900 mb-1 break-words"
                    >
                      <span th:text="${cart.variant.product.productName}"
                        >iPhone 14 128GB</span
                      >
                      <span
                        th:if="${cart.variant.storage != null}"
                        th:text="' - ' + ${cart.variant.storage}"
                      >
                        - Chính hãng VN/A</span
                      >
                    </h3>
                    <div class="flex justify-between items-center">
                      <p
                        class="text-sm text-gray-500"
                        th:text="${cart.variant.color} ?: ''"
                      >
                        Trắng
                      </p>
                      <p class="text-sm font-semibold text-blue-600">
                        <span
                          th:if="${cart.variant.discountedPrice != null}"
                          th:text="${#numbers.formatDecimal(cart.variant.discountedPrice, 1, 'COMMA', 0, 'POINT') + '₫'}"
                        >
                          15.990.000₫
                        </span>
                        <span
                          th:unless="${cart.variant.discountedPrice != null}"
                          th:text="${#numbers.formatDecimal(cart.variant.price, 1, 'COMMA', 0, 'POINT') + '₫'}"
                        >
                          15.990.000₫
                        </span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mã giảm giá -->
            <div class="mt-4">
              <div class="flex items-center">
                <input
                  type="text"
                  placeholder="Nhập mã giảm giá"
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-l-md text-sm"
                />
                <button
                  class="px-6 py-2 bg-blue-500 text-white rounded-r-md text-sm font-medium hover:bg-yellow-500"
                >
                  Áp dụng
                </button>
              </div>
            </div>

            <!-- Giá -->
            <div class="mt-6 space-y-2 text-sm text-gray-700">
              <div class="flex justify-between">
                <span>Tạm tính</span>
                <span
                  class="font-medium"
                  th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 0, 'POINT') + '₫'}"
                  >15.900.000₫</span
                >
              </div>
              <div class="flex justify-between">
                <span>Phí vận chuyển</span>
                <span class="font-medium">0₫</span>
              </div>
              <div
                class="flex justify-between text-base font-semibold text-gray-900 pt-4 border-t border-gray-200"
              >
                <span>Tổng cộng</span>
                <span
                  style="font-size: 22px; font-weight: 700; color: #000f8f"
                  th:text="${#numbers.formatDecimal(total, 1, 'COMMA', 0, 'POINT') + '₫'}"
                >
                  15.900.000₫
                </span>
              </div>
            </div>

            <div class="mt-6">
              <button
                onclick="confirmOrder()"
                class="block text-center w-full px-6 py-3 bg-blue-500 text-white rounded-md font-medium hover:bg-yellow-500 transition-colors duration-300"
              >
                XÁC NHẬN ĐẶT HÀNG
              </button>
            </div>
            <a
              href="cart"
              class="group flex items-center justify-center text-sm text-blue-500 hover:text-yellow-500 mt-4 transition-colors duration-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-2 transform transition-transform duration-300 group-hover:-translate-x-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
              <span class="">Quay về giỏ hàng</span>
            </a>
          </div>
        </div>
      </div>
      <!-- Thông báo Đặt hàng thành công -->
      <div
        id="success-message"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm text-center">
          <h2 class="text-lg font-semibold text-green-600 mb-2">
            Đặt hàng thành công!
          </h2>
          <p class="mb-4">Cảm ơn bạn đã mua hàng.</p>
          <button
            onclick="redirectHome()"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
          >
            OK
          </button>
        </div>
      </div>
    </main>
    <script>
      function confirmOrder() {
        const fullAddress = document.getElementById("full-address").value;
        const note = document.getElementById("note")?.value || "";

        fetch("/checkout/save-address", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `address=${encodeURIComponent(
            fullAddress
          )}&note=${encodeURIComponent(note)}`,
        })
          .then(() => {
            return fetch("/checkout/cod-confirm");
          })
          .then((response) => {
            if (response.redirected) {
              document
                .getElementById("success-message")
                .classList.remove("hidden");
              setTimeout(() => (window.location.href = "/home"), 2000);
            }
          })
          .catch(() => {
            alert("Đã có lỗi xảy ra khi xác nhận đơn hàng!");
          });
      }
    </script>

    <script>
      function updateFullAddress() {
        const address = document.getElementById("address").value;
        const ward =
          document.getElementById("ward").selectedOptions[0]?.text || "";
        const district =
          document.getElementById("district").selectedOptions[0]?.text || "";
        const province =
          document.getElementById("province").selectedOptions[0]?.text || "";

        const fullAddress = [address, ward, district, province]
          .filter(
            (part) =>
              part &&
              part !== "Chọn Tỉnh/TP" &&
              part !== "Chọn Quận/Huyện" &&
              part !== "Chọn Phường/Xã"
          )
          .join(", ");

        const fullAddressInput = document.getElementById("full-address");
        fullAddressInput.value = fullAddress;
        localStorage.setItem("full-address", fullAddress);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const addressInput = document.getElementById("address");
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");
        const noteInput = document.getElementById("note");
        const fullAddressInput = document.getElementById("full-address");

        // Khôi phục dữ liệu từ localStorage
        if (localStorage.getItem("address"))
          addressInput.value = localStorage.getItem("address");
        if (localStorage.getItem("note"))
          noteInput.value = localStorage.getItem("note");
        if (localStorage.getItem("full-address"))
          fullAddressInput.value = localStorage.getItem("full-address");

        const savedProvince = localStorage.getItem("province");
        const savedDistrict = localStorage.getItem("district");
        const savedWard = localStorage.getItem("ward");

        // Load danh sách tỉnh
        fetch("https://provinces.open-api.vn/api/p/")
          .then((res) => res.json())
          .then((provinces) => {
            provinceSelect.innerHTML = '<option value="">Chọn Tỉnh/TP</option>';
            provinces.forEach((province) => {
              const option = document.createElement("option");
              option.value = province.code;
              option.textContent = province.name;
              provinceSelect.appendChild(option);
            });

            if (savedProvince) {
              provinceSelect.value = savedProvince;
              return fetch(
                `https://provinces.open-api.vn/api/p/${savedProvince}?depth=2`
              );
            }
          })
          .then((res) => res?.json())
          .then((provinceData) => {
            if (!provinceData || !provinceData.districts) return;
            districtSelect.innerHTML =
              '<option value="">Chọn Quận/Huyện</option>';
            provinceData.districts.forEach((district) => {
              const option = document.createElement("option");
              option.value = district.code;
              option.textContent = district.name;
              districtSelect.appendChild(option);
            });

            if (savedDistrict) {
              districtSelect.value = savedDistrict;
              return fetch(
                `https://provinces.open-api.vn/api/d/${savedDistrict}?depth=2`
              );
            }
          })
          .then((res) => res?.json())
          .then((districtData) => {
            if (!districtData || !districtData.wards) return;
            wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
            districtData.wards.forEach((ward) => {
              const option = document.createElement("option");
              option.value = ward.code;
              option.textContent = ward.name;
              wardSelect.appendChild(option);
            });

            if (savedWard) {
              wardSelect.value = savedWard;
            }

            // ✅ Sau khi load xong hết: cập nhật lại địa chỉ đầy đủ
            updateFullAddress();
          });

        // Sự kiện lưu localStorage
        addressInput.addEventListener("input", () => {
          localStorage.setItem("address", addressInput.value);
          updateFullAddress();
        });
        noteInput.addEventListener("input", () => {
          localStorage.setItem("note", noteInput.value);
        });
        provinceSelect.addEventListener("change", () => {
          localStorage.setItem("province", provinceSelect.value);
          districtSelect.innerHTML =
            '<option value="">Chọn Quận/Huyện</option>';
          wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
          updateFullAddress();

          const provinceCode = provinceSelect.value;
          if (provinceCode) {
            fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
              .then((res) => res.json())
              .then((data) => {
                data.districts.forEach((district) => {
                  const option = document.createElement("option");
                  option.value = district.code;
                  option.textContent = district.name;
                  districtSelect.appendChild(option);
                });
              });
          }
        });
        districtSelect.addEventListener("change", () => {
          localStorage.setItem("district", districtSelect.value);
          wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
          updateFullAddress();

          const districtCode = districtSelect.value;
          if (districtCode) {
            fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
              .then((res) => res.json())
              .then((data) => {
                data.wards.forEach((ward) => {
                  const option = document.createElement("option");
                  option.value = ward.code;
                  option.textContent = ward.name;
                  wardSelect.appendChild(option);
                });
              });
          }
        });
        wardSelect.addEventListener("change", () => {
          localStorage.setItem("ward", wardSelect.value);
          updateFullAddress();
        });
      });

      // Xác nhận đơn hàng COD
      function confirmOrder() {
        const fullAddress = document.getElementById("full-address").value;
        const note = document.getElementById("note")?.value || "";

        fetch("/checkout/save-address", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `address=${encodeURIComponent(
            fullAddress
          )}&note=${encodeURIComponent(note)}`,
        })
          .then(() => fetch("/checkout/cod-confirm"))
          .then((response) => {
            if (response.redirected) {
              document
                .getElementById("success-message")
                .classList.remove("hidden");
              setTimeout(() => (window.location.href = "/home"), 2000);
            }
          })
          .catch(() => {
            alert("Đã có lỗi xảy ra khi xác nhận đơn hàng!");
          });
      }

      // Xử lý chuyển phương thức thanh toán
      document.addEventListener("DOMContentLoaded", function () {
        const bankRadio = document.getElementById("bank-payment");
        const codRadio = document.getElementById("cod-payment");
        const bankSection = document.getElementById("bank-section");
        const codSection = document.getElementById("cod-section");

        function togglePayment() {
          if (codRadio.checked) {
            bankSection.classList.add("hidden");
            codSection.classList.remove("hidden");
          } else {
            codSection.classList.add("hidden");
            bankSection.classList.remove("hidden");
          }
        }

        bankRadio.addEventListener("change", togglePayment);
        codRadio.addEventListener("change", togglePayment);
      });

      // Thanh toán VNPay
      document.addEventListener("DOMContentLoaded", function () {
        const submitButton = document.getElementById("vnpay-button");
        submitButton.addEventListener("click", function () {
          const fullAddress = document.getElementById("full-address").value;
          const note = document.getElementById("note")?.value || "";

          if (!fullAddress) {
            alert("Vui lòng nhập địa chỉ giao hàng.");
            return;
          }

          fetch("/checkout/save-address", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `address=${encodeURIComponent(
              fullAddress
            )}&note=${encodeURIComponent(note)}`,
          })
            .then(() => {
              window.location.href = "/checkout/payment";
            })
            .catch(() => {
              alert("Không thể lưu địa chỉ. Vui lòng thử lại.");
            });
        });
      });
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");

        // Load Tỉnh/Thành phố
        fetch("https://provinces.open-api.vn/api/p/")
          .then((res) => res.json())
          .then((data) => {
            data.forEach((province) => {
              const option = document.createElement("option");
              option.value = province.code;
              option.textContent = province.name;
              provinceSelect.appendChild(option);
            });
          });

        // Khi chọn Tỉnh/TP -> Load Quận/Huyện
        provinceSelect.addEventListener("change", function () {
          const provinceCode = this.value;
          districtSelect.innerHTML =
            '<option value="">Chọn Quận/Huyện</option>';
          wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

          if (provinceCode) {
            fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
              .then((res) => res.json())
              .then((data) => {
                data.districts.forEach((district) => {
                  const option = document.createElement("option");
                  option.value = district.code;
                  option.textContent = district.name;
                  districtSelect.appendChild(option);
                });
              });
          }
        });

        // Khi chọn Quận/Huyện -> Load Phường/Xã
        districtSelect.addEventListener("change", function () {
          const districtCode = this.value;
          wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

          if (districtCode) {
            fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
              .then((res) => res.json())
              .then((data) => {
                data.wards.forEach((ward) => {
                  const option = document.createElement("option");
                  option.value = ward.code;
                  option.textContent = ward.name;
                  wardSelect.appendChild(option);
                });
              });
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const bankRadio = document.getElementById("bank-payment");
        const codRadio = document.getElementById("cod-payment");
        const bankSection = document.getElementById("bank-section");
        const codSection = document.getElementById("cod-section");

        function togglePayment() {
          if (codRadio.checked) {
            bankSection.classList.add("hidden");
            codSection.classList.remove("hidden");
          } else {
            codSection.classList.add("hidden");
            bankSection.classList.remove("hidden");
          }
        }

        bankRadio.addEventListener("change", togglePayment);
        codRadio.addEventListener("change", togglePayment);
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const submitButton = document.getElementById("vnpay-button");

        submitButton.addEventListener("click", function () {
          const fullAddress = document.getElementById("full-address").value;
          const note = document.getElementById("note")?.value || "";

          if (!fullAddress) {
            alert("Vui lòng nhập địa chỉ giao hàng.");
            return;
          }

          fetch("/checkout/save-address", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `address=${encodeURIComponent(
              fullAddress
            )}&note=${encodeURIComponent(note)}`,
          })
            .then(() => {
              window.location.href = "/checkout/payment"; // chuyển hướng sau khi lưu
            })
            .catch(() => {
              alert("Không thể lưu địa chỉ. Vui lòng thử lại.");
            });
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const addressInput = document.getElementById("address");
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");
        const noteInput = document.getElementById("note");
        const fullAddressInput = document.getElementById("full-address");

        // Gán lại dữ liệu tĩnh
        if (localStorage.getItem("address")) {
          addressInput.value = localStorage.getItem("address");
        }
        if (localStorage.getItem("note")) {
          noteInput.value = localStorage.getItem("note");
        }
        if (localStorage.getItem("full-address")) {
          fullAddressInput.value = localStorage.getItem("full-address");
        }

        const savedProvince = localStorage.getItem("province");
        const savedDistrict = localStorage.getItem("district");
        const savedWard = localStorage.getItem("ward");

        // Load danh sách tỉnh
        fetch("https://provinces.open-api.vn/api/p/")
          .then((res) => res.json())
          .then((provinces) => {
            provinceSelect.innerHTML = '<option value="">Chọn Tỉnh/TP</option>';
            provinces.forEach((province) => {
              const option = document.createElement("option");
              option.value = province.code;
              option.textContent = province.name;
              provinceSelect.appendChild(option);
            });

            if (savedProvince) {
              provinceSelect.value = savedProvince;
              return fetch(
                `https://provinces.open-api.vn/api/p/${savedProvince}?depth=2`
              );
            }
          })
          .then((res) => res?.json())
          .then((provinceData) => {
            if (!provinceData || !provinceData.districts) return;
            districtSelect.innerHTML =
              '<option value="">Chọn Quận/Huyện</option>';
            provinceData.districts.forEach((district) => {
              const option = document.createElement("option");
              option.value = district.code;
              option.textContent = district.name;
              districtSelect.appendChild(option);
            });

            if (savedDistrict) {
              districtSelect.value = savedDistrict;
              return fetch(
                `https://provinces.open-api.vn/api/d/${savedDistrict}?depth=2`
              );
            }
          })
          .then((res) => res?.json())
          .then((districtData) => {
            if (!districtData || !districtData.wards) return;
            wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
            districtData.wards.forEach((ward) => {
              const option = document.createElement("option");
              option.value = ward.code;
              option.textContent = ward.name;
              wardSelect.appendChild(option);
            });

            if (savedWard) {
              wardSelect.value = savedWard;
            }
          });

        // Lưu vào localStorage khi người dùng thay đổi
        addressInput.addEventListener("input", () => {
          localStorage.setItem("address", addressInput.value);
        });
        noteInput.addEventListener("input", () => {
          localStorage.setItem("note", noteInput.value);
        });
        provinceSelect.addEventListener("change", () => {
          localStorage.setItem("province", provinceSelect.value);
        });
        districtSelect.addEventListener("change", () => {
          localStorage.setItem("district", districtSelect.value);
        });
        wardSelect.addEventListener("change", () => {
          localStorage.setItem("ward", wardSelect.value);
        });
        fullAddressInput.addEventListener("input", () => {
          localStorage.setItem("full-address", fullAddressInput.value);
        });
      });
    </script>
  </body>
</html>
