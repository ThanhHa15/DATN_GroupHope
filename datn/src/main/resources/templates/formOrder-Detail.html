<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>Quản lý voucher</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>tailwind.config = { theme: { extend: { colors: { primary: '#1e88e5', secondary: '#f5f5f5' }, borderRadius: { 'none': '0px', 'sm': '4px', DEFAULT: '8px', 'md': '12px', 'lg': '16px', 'xl': '20px', '2xl': '24px', '3xl': '32px', 'full': '9999px', 'button': '8px' } } } }</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>

  <style>
    body {
      background-color: #f0f3f7;
      margin: 0;
      font-family: 'Poppins', sans-serif;
      color: #2c3e50;
    }

    :where([class^="ri-"])::before {
      content: "\f3c2";
    }

    .active-link {
      color: #e5a500;
      font-weight: 600;
    }

    .status-pending {
      color: #e5a500;
    }

    .disabled-element {
      pointer-events: none;
      opacity: 0.6;
    }
  </style>
</head>

<body>
  <div th:replace="nav :: na"></div>
  <div th:replace="header :: header"></div>

  <h1 style="margin-left: 300px; font-size: 23px; margin-top: 78px;">Quản lý đơn hàng chi tiết</h1>

  <div class="flex justify-center bg-[#f2f2f2] px-4 pb-10">
    <div class="w-full max-w-[1200px] bg-white shadow-md rounded-lg px-8 py-6"
      style="margin-left: 287px; margin-top: 20px;">

      <!-- Thêm nút quay lại danh sách đơn hàng -->
      <div class="flex justify-between items-start mb-4">
        <a href="/admin-order" class="flex items-center text-blue-600 hover:text-blue-800">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
              clip-rule="evenodd" />
          </svg>
          Quay lại
        </a>

        <!-- Thêm dropdown hành động (ẩn khi đơn hàng đã hủy) -->
        <div class="relative" th:unless="${order.orderStatus == 'Đã hủy'}">
          <button id="actionDropdownButton"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
            Hành động
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                clip-rule="evenodd" />
            </svg>
          </button>
          <div id="actionDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
            <div class="py-1">
              <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">In đơn hàng</a>
              <a th:unless="${order.paymentStatus == 'Đã thanh toán' or order.paymentStatus == 'Đã hoàn tiền' or order.paymentStatus == 'Chờ hoàn tiền'}"
                th:href="@{'/admin-order/mark-as-paid/' + ${order.id}}"
                class="mark-as-paid block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                Đánh dấu đã thanh toán
              </a>

            </div>
          </div>
        </div>
      </div>


      <!-- Hiển thị thông tin trả hàng -->
      <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm" th:if="${order.returnReason != null}">
        <h2 class="text-[#080c8c] font-bold mb-2 text-lg">YÊU CẦU TRẢ HÀNG</h2>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
          <!-- Order Info Boxes -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <div class="flex justify-between items-center mb-2">
                <h2 class="font-bold text-lg text-[#080c8c]">LÝ DO TRẢ HÀNG</h2>
                <p th:if="${order.returnRequestDate != null}" class="text-base text-gray-600">
                  <span th:text="${#temporals.format(order.returnRequestDate, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
              </div>
              <p th:text="${order.returnReason}" class="text-gray-700 text-base font-semibold mb-3"></p>
              <!-- Hiển thị ảnh đính kèm -->
              <div th:if="${order.returnImages != null and not #strings.isEmpty(order.returnImages)}">
                <p class="text-sm font-medium text-gray-700 mb-2">Hình ảnh đính kèm:</p>
                <div class="flex flex-wrap gap-2">
                  <a th:each="image : ${#strings.arraySplit(order.returnImages, ',')}" th:href="${image}"
                    target="_blank" class="w-20 h-20 border rounded overflow-hidden">
                    <img th:src="${image}" class="w-full h-full object-cover" />
                  </a>
                </div>
              </div>
            </div>


            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <h2 class="text-[#080c8c] font-bold mb-2 text-lg">THÔNG TIN HOÀN TIỀN </h2>
              <div class="mt-2" th:if="${order.bankAccountNumber != null}">

                <div class="text-base text-gray-600 font-semibold space-y-1 mb-2">
                  <p class="text-blue-700">Ngân hàng: <span class="text-gray-600" th:text="${order.bankName}"></span>
                  </p>
                  <p class="text-blue-700">Số tài khoản:
                    <span class="text-gray-600" th:text="${order.bankAccountNumber}"></span>
                  </p>
                  <p class="text-blue-700">Chủ tài khoản: <span class="text-gray-600"
                      th:text="${order.accountHolder}"></span></p>
                </div>
                <hr>
                <p class="text-blue-700 text-base font-semibold mt-2">Số tiền: <span class="text-gray-600"
                    th:text="${#numbers.formatDecimal(order.refundAmount != null ? order.refundAmount : order.totalPrice, 1, 'COMMA', 0, 'POINT') + '₫'}"></span>
                </p>
              </div>
            </div>

            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
              <h2 class="text-[#080c8c] font-bold text-lg">PHƯƠNG THỨC TRẢ HÀNG</h2>
              <p th:text="${#strings.contains(order.returnMethod, 'POST_OFFICE') ? 'Trả tại bưu cục' : 'Shipper đến nhận'}"
                class="text-gray-700 text-base font-semibold ">
              </p>

              <!-- Thông báo hướng dẫn thêm nếu có trạng thái hoàn tiền và đơn hàng chưa "Đã giao hàng" -->
              <div class="mb-3">
                <p th:if="${#strings.contains(order.returnMethod, 'POST_OFFICE')}"
                  class="text-sm text-amber-600 italic">

                </p>
                <p th:if="${#strings.contains(order.returnMethod, 'PICKUP')}" class="text-sm text-amber-600 italic">

                </p>
              </div>
            </div>



          </div>

          <!-- Form xử lý yêu cầu trả hàng -->
          <div class="mt-4" th:if="${order.orderStatus == 'Yêu cầu trả hàng'}">
            <form th:action="@{'/admin-order/process-return/' + ${order.id}}" method="post">

              <!-- Quyết định -->
              <div class="mb-3">
                <label class="block text-[#080c8c] font-bold text-lg mb-1">Quyết định</label>
                <select id="returnDecision" name="returnDecision"
                  class="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm w-full">
                  <option value="">-- Chọn quyết định --</option>
                  <option value="ACCEPT">Chấp nhận trả hàng</option>
                  <option value="REJECT">Từ chối yêu cầu</option>
                </select>
              </div>

              <!-- Lý do từ chối (ẩn mặc định) -->
              <div id="rejectReason" class="mb-3 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Lý do (nếu từ chối)</label>
                <textarea name="adminResponse" rows="2"
                  class="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm w-full"></textarea>
              </div>

              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm">
                Xác nhận
              </button>
            </form>
          </div>

          <!-- Nút xác nhận hoàn tiền -->
          <div class="mt-4" th:if="${order.orderStatus == 'Đơn đang được trả về shop'}">
            <form th:action="@{'/admin-order/confirm-refund/' + ${order.id}}" method="post">
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md text-sm">
                Xác nhận đã hoàn tiền
              </button>
            </form>
          </div>

          <!-- Hiển thị phản hồi admin nếu đã xử lý -->
          <div class="mt-4" th:if="${order.returnStatus == 'Đã xử lý' || order.returnStatus == 'Từ chối'}">
            <p class="text-[#080c8c] font-bold mt-2 text-lg">Phản hồi của quản trị viên:</p>
            <p class="text-base text-gray-700 mt-1" th:text="${order.adminResponse}"></p>
            <p class="text-sm text-gray-500 mt-1" th:if="${order.returnProcessedDate != null}">
              Ngày xử lý: <span th:text="${#temporals.format(order.returnProcessedDate, 'dd/MM/yyyy HH:mm')}"></span>
            </p>
          </div>
        </div>
      </div>

      <!-- Thêm box lý do hủy nếu đơn hàng đã hủy -->
      <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm" th:if="${order.orderStatus == 'Đã hủy'}">
        <h2 class="text-[#080c8c] font-bold mb-2 text-lg">LÝ DO HỦY ĐƠN HÀNG</h2>
        <div class="bg-red-50 border-l-4 border-red-400 p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-red-700" th:text="${order.cancelReason}"></p>
              <p class="text-xs text-red-500 mt-1" th:if="${order.cancelDate != null}">
                Thời gian hủy: <span th:text="${#temporals.format(order.cancelDate, 'dd/MM/yyyy HH:mm')}"></span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Thông báo đơn hàng đã hủy -->
      <div th:if="${order.orderStatus == 'Đã hủy'}" class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-red-700">Đơn hàng đã bị hủy và không thể chỉnh sửa.</p>
          </div>
        </div>
      </div>

      <!-- Order Header -->
      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-2">
        <h1 class="text-3xl font-bold text-gray-900">
          Chi tiết đơn hàng <span class="text-lg text-gray-600">#<span th:text="${order.orderCode}"></span></span>
        </h1>
        <p class="text-gray-500 text-base">Ngày tạo: <span
            th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span></p>
      </div>

      <!-- Phần cập nhật trạng thái (ẩn khi đơn hàng đã hủy) -->
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6"
        th:unless="${order.orderStatus == 'Đã hủy' or order.orderStatus == 'Đã giao hàng' or order.orderStatus == 'Yêu cầu trả hàng' or order.orderStatus == 'Trả hàng thành công' or order.orderStatus == 'Từ chối trả hàng' or order.orderStatus == 'Đơn đang được trả về shop'}">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3 w-full">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
              <p class="text-sm text-yellow-700">
                Cập nhật trạng thái đơn hàng
              </p>
              <div class="mt-2 md:mt-0 flex gap-2">
                <form th:action="@{/admin-order/update-status/{orderId}(orderId=${order.id})}" method="post">
                  <select name="status"
                    class="border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">

                    <!-- Nếu đang Chờ xác nhận thì có thể chuyển sang Đã xác nhận hoặc Hủy đơn -->
                    <option th:if="${order.orderStatus == 'Chờ xác nhận'}" value="Đã xác nhận">Đã xác nhận</option>
                    <option th:if="${order.orderStatus == 'Chờ xác nhận'}" value="Đã hủy">Hủy đơn hàng</option>

                    <!-- Nếu đang Đã xác nhận thì chỉ cho chọn Đang đóng gói -->
                    <option th:if="${order.orderStatus == 'Đã xác nhận'}" value="Đang đóng gói">Đang đóng gói</option>

                    <!-- Nếu đang Đang đóng gói thì chỉ cho chọn Đang vận chuyển -->
                    <option th:if="${order.orderStatus == 'Đang đóng gói'}" value="Đang vận chuyển">Đang vận chuyển
                    </option>

                    <!-- Nếu đang Đang vận chuyển thì chỉ cho chọn Đã giao hàng -->
                    <option th:if="${order.orderStatus == 'Đang vận chuyển'}" value="Đã giao hàng">Đã giao hàng</option>

                  </select>


                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-md text-sm">
                    Cập nhật
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Status -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="flex items-center text-base">
          <span class="text-gray-700 font-semibold mr-1">TT thanh toán:</span>
          <span th:text="${order.paymentStatus}" style="font-weight: 600;" th:classappend="
        ${order.paymentStatus == 'Đã thanh toán'} ? 'text-green-500' :
        (${order.paymentStatus == 'Đã hoàn tiền'} ? 'text-green-500' :
        'text-[#e5a500]')">
          </span>

        </div>
        <div class="flex items-center text-base">
          <span class="text-gray-700 font-semibold mr-1">TT đơn hàng:</span>
          <span th:switch="${order.orderStatus}" class="status-pending font-semibold">
            <span th:case="'Đã giao hàng'" class="text-green-500" th:text="${order.orderStatus}"></span>
            <span th:case="'Trả hàng thành công'" class="text-green-500" th:text="${order.orderStatus}"></span>
            <span th:case="'Đã hủy'" class="text-red-500" th:text="${order.orderStatus}"></span>
            <span th:case="'Từ chối trả hàng'" class="text-red-500" th:text="${order.orderStatus}"></span>
            <span th:case="'Chờ xác nhận'" class="text-amber-500" th:text="${order.orderStatus}"></span>
            <span th:case="'Đang vận chuyển'" class="text-blue-500" th:text="${order.orderStatus}"></span>
            <span th:case="*" class="text-gray-500" th:text="${order.orderStatus}"></span>
          </span>

        </div>
        <div class="flex items-center text-base">
          <span class="text-gray-700 font-semibold mr-1">Mã vận đơn:</span>
          <span th:text="' #' + ${order.orderCode}" class="text-gray-800 font-medium">—</span>
        </div>
      </div>

      <!-- Order Info Boxes -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative">
          <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"
            th:disabled="${order.orderStatus == 'Đã hủy'}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <h2 class="font-bold mb-2 text-lg text-[#080c8c]">ĐỊA CHỈ GIAO HÀNG</h2>
          <p th:text="${order.member.fullname}" class="text-gray-800 text-base font-semibold"></p>
          <p th:text="${order.address}" class="text-gray-700 text-sm"></p>
          <p th:text="${order.member.phone}" class="text-gray-700 text-sm"></p>
        </div>

        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative">
          <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"
            th:disabled="${order.orderStatus == 'Đã hủy'}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <h2 class="text-[#080c8c] font-bold mb-2 text-lg">THANH TOÁN</h2>
          <p th:text="${order.paymentMethod}" class="text-gray-700 text-base font-semibold"></p>
        </div>

        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm relative">
          <button class="absolute top-2 right-2 text-gray-400 hover:text-gray-600"
            th:disabled="${order.orderStatus == 'Đã hủy'}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <h2 class="text-[#080c8c] font-bold mb-2 text-lg">GHI CHÚ</h2>
          <p th:text="${#strings.isEmpty(order.note) ? 'Không có ghi chú' : order.note}"
            class="text-gray-700 text-base font-semibold">
          </p>
        </div>
      </div>

      <!-- Order Items -->
      <div class="bg-white rounded-lg border border-gray-200 overflow-hidden mb-6">
        <table class="w-full table-auto border-collapse">
          <thead class="bg-gray-50">
            <tr>
              <th class="py-3 px-4 border border-gray-200 text-left text-gray-700 font-bold text-base">Sản phẩm</th>

              <th class="py-3 px-4 border border-gray-200 text-right text-gray-700 font-bold text-base min-w-[120px]">
                Đơn giá</th>
              <th class="py-3 px-4 border border-gray-200 text-center text-gray-700 font-bold text-base min-w-[100px]">
                Số lượng</th>
              <th class="py-3 px-4 border border-gray-200 text-right text-gray-700 font-bold text-base min-w-[120px]">
                Tổng</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="detail : ${orderDetails}" class="text-base">
              <td class="py-3 px-4 border border-gray-200">
                <div class="flex items-center gap-3">
                  <img th:src="@{'/images/' + ${detail.productVariant.imagesno2}}"
                    class="w-12 h-12 object-contain rounded bg-gray-100" />

                  <div>
                    <div class="text-gray-800 font-semibold text-sm"
                      th:text="${detail.productVariant.product.productName}"></div>
                    <div class="text-gray-500 text-xs mt-1">
                      <span th:text="'Màu: ' + ${detail.productVariant.color}"></span> |
                      <span th:text="'Dung lượng: ' + ${detail.productVariant.storage}"></span>
                    </div>
                  </div>
                </div>
              </td>

             

              <td class="py-3 px-4 border border-gray-200 text-right text-gray-800 font-medium"
                th:text="${#numbers.formatDecimal(detail.price, 1, 'COMMA', 0, 'POINT') + '₫'}"></td>

              <td class="py-3 px-4 border border-gray-200 text-center text-gray-800 font-medium"
                th:text="${detail.quantity}"></td>

              <td class="py-3 px-4 border border-gray-200 text-right text-gray-800 font-medium"
                th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 1, 'COMMA', 0, 'POINT') + '₫'}">
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Order Summary -->
      <div class="bg-white rounded-lg border border-gray-200 p-6 space-y-2">
        <div class="flex justify-between text-base py-1">
          <span class="text-gray-600 font-semibold">Tổng tiền sản phẩm:</span>
          <span class="text-gray-800 font-medium"
            th:text="${#numbers.formatDecimal(productTotal, 1, 'COMMA', 0, 'POINT') + '₫'}">0₫</span>
        </div>

        <div class="flex justify-between text-base py-1">
          <span class="text-gray-600 font-semibold">Phí vận chuyển:</span>
          <span class="text-gray-800 font-medium"
            th:text="${#numbers.formatDecimal(shippingFee, 1, 'COMMA', 0, 'POINT') + '₫'}">0₫</span>
        </div>

        <div class="flex justify-between text-base py-1">
          <span class="text-gray-600 font-semibold">Tạm tính:</span>
          <span class="text-gray-800 font-medium"
            th:text="${#numbers.formatDecimal(subtotal, 1, 'COMMA', 0, 'POINT') + '₫'}">0₫</span>
        </div>

        <div class="flex justify-between text-base py-1" th:if="${discountAmount > 0}">
          <span class="text-gray-600 font-semibold">Giảm giá:</span>
          <span class="text-green-600 font-medium"
            th:text="'- ' + ${#numbers.formatDecimal(discountAmount, 1, 'COMMA', 0, 'POINT') + '₫'}">0₫</span>
        </div>
        <div class="flex justify-between text-base py-1" th:if="${discountAmount <= 0}">
          <span class="text-gray-600 font-semibold">Giảm giá:</span>
          <span class="text-gray-800 font-medium">0₫</span>
        </div>

        <div class="flex justify-between items-center py-3 border-t border-gray-100">
          <span class="text-gray-800 font-bold text-lg">Tổng tiền:</span>
          <span class="text-red-600 text-2xl font-bold"
            th:text="${#numbers.formatDecimal(grandTotal, 1, 'COMMA', 0, 'POINT') + '₫'}">0₫</span>
        </div>
      </div>
    </div>
  </div>


  <script> // Hiển thị/ẩn lý do từ chối khi chọn quyết định trả hàng
    document.addEventListener("DOMContentLoaded", function () {
      const decisionSelect = document.getElementById("returnDecision");
      const rejectReasonDiv = document.getElementById("rejectReason");
      const adminResponse = document.getElementById("adminResponse");

      decisionSelect.addEventListener("change", function () {
        if (this.value === "REJECT") {
          rejectReasonDiv.classList.remove("hidden");
          adminResponse.setAttribute("required", "required");
        } else {
          rejectReasonDiv.classList.add("hidden");
          adminResponse.removeAttribute("required");
        }
      });
    });
  </script>

  <script>// Hiển thị/ẩn thông tin hoàn tiền khi thay đổi quyết định

    document.getElementById('returnDecision').addEventListener('change', function () {
      const refundInfo = document.getElementById('refundInfo');
      if (this.value === 'ACCEPT') {
        refundInfo.classList.remove('hidden');
      } else {
        refundInfo.classList.add('hidden');
      }
    });
  </script>

  <script> // Script để xử lý dropdown hành động

    document.getElementById('actionDropdownButton')?.addEventListener('click', function () {
      document.getElementById('actionDropdown').classList.toggle('hidden');
    });

    // Đóng dropdown khi click ra ngoài
    window.addEventListener('click', function (event) {
      if (!event.target.matches('#actionDropdownButton')) {
        var dropdowns = document.getElementsByClassName('dropdown-content');
        for (var i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (!openDropdown.classList.contains('hidden')) {
            openDropdown.classList.add('hidden');
          }
        }
      }
    });
  </script>

  <script> // Xử lý sự kiện click cho các liên kết xử lý trả hàng
    // Thêm vào phần script cuối trang
    document.querySelectorAll('.process-return').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        window.location.href = this.getAttribute('href');
      });
    });
  </script>

  <script> // Xử lý sự kiện click cho các liên kết đánh dấu đã thanh toán
    document.addEventListener('DOMContentLoaded', function () {
      // Xử lý nút đánh dấu đã thanh toán
      document.querySelectorAll('.mark-as-paid').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          if (confirm('Bạn có chắc chắn muốn đánh dấu đơn hàng này là đã thanh toán?')) {
            window.location.href = this.getAttribute('href');
          }
        });
      });

      // Vô hiệu hóa các phần tử khi đơn hàng đã hủy
      if (document.querySelector('[th\\:if="${order.orderStatus == \'Đã hủy\'}"]')) {
        document.querySelectorAll('button, a, select, input').forEach(element => {
          if (!element.classList.contains('no-disable') &&
            !element.hasAttribute('th:unless') &&
            element.id !== 'actionDropdownButton') {
            element.disabled = true;
            element.classList.add('disabled-element');
          }
        });
      }
    });
  </script>
</body>

</html>