<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Thống kê Doanh thu</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: "#1e88e5", secondary: "#f5f5f5" },
                    borderRadius: {
                        none: "0px",
                        sm: "4px",
                        DEFAULT: "8px",
                        md: "12px",
                        lg: "16px",
                        xl: "20px",
                        "2xl": "24px",
                        "3xl": "32px",
                        full: "9999px",
                        button: "8px",
                    },
                },
            },
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
        }

        .summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 28%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #444;
        }

        .card p {
            font-size: 18px;
            color: #27ae60;
            font-weight: bold;
        }

        .charts {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        /* Tuần nhỏ hơn */
        .chart-week {
            flex: 0.8;
            height: 400px;
        }

        /* Năm to hơn */
        .chart-year {
            flex: 1.5;
            height: 400px;
        }

        .chart {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .line-chart-container {
            position: relative;
            height: 100%;
        }

        .filter {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .filter label {
            font-size: 14px;
            color: #444;
        }

        .filter input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f0f0f0;
            color: #444;
        }

        tr:hover {
            background: #fafafa;
        }
    </style>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        body {
            background-color: #f0f3f7;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: #2c3e50;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            flex: 1;
            min-width: 240px;
            text-decoration: none;
            position: relative;
        }

        .stat-card::before {
            content: "";
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #eaf6f2;
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }

        .stat-icon {
            width: 24px;
            height: 24px;
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }

        .stat-title {
            font-size: 14px;
            color: #666;
            margin-top: 30px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
        }

        .stat-change {
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }

        .stat-link {
            text-align: center;
            display: block;
            font-size: 14px;
            text-decoration: underline;
            color: #000;
        }

        .green {
            color: #16c784;
        }

        .red {
            color: #ef4444;
        }

        .blue {
            color: #3b82f6;
        }

        .yellow {
            color: #090909;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

</head>

<body>
    <div th:replace="nav :: na"></div>
    <div th:replace="header :: header"></div>

    <div style="margin-left: 300px; margin-top: 70px; margin-bottom: 40px;">
        <h1 style="font-size: 23px; margin-bottom: 30px;">Thống kê Doanh thu</h1>

        <div class="container" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px">
            <!-- Card 1 - Tổng doanh thu -->
            <div class="stat-card" id="revenue-card">
                <div class="loading-overlay" id="revenue-loading" style="display: none;">
                    <div class="spinner"></div>
                </div>
                <img src="https://cdn-icons-png.flaticon.com/512/263/263115.png" class="stat-icon" />
                <div class="stat-title">Tổng doanh thu</div>
                <div class="stat-value">
                    <span id="total-revenue">Đang tải...</span><span class="underline">đ</span>
                </div>
                <div class="stat-change green" id="revenue-change">↑ +0.00%</div>
                <a href="#" class="stat-link">Xem tất cả doanh thu</a>
                <div class="error-message" id="revenue-error"></div>
            </div>

            <!-- Card 2 - Tổng đơn hàng -->
            <div class="stat-card" id="orders-card">
                <div class="loading-overlay" id="orders-loading" style="display: none;">
                    <div class="spinner"></div>
                </div>
                <img src="https://cdn-icons-png.flaticon.com/512/1040/1040230.png" class="stat-icon" />
                <div class="stat-title">Tổng đơn hàng</div>
                <div class="stat-value" id="total-orders">Đang tải...</div>
                <div class="stat-change red" id="orders-change">↓ -80.00%</div>
                <a href="#" class="stat-link">Xem tất cả đơn hàng</a>
                <div class="error-message" id="orders-error"></div>
            </div>

            <!-- Card 3 - Tổng số khách hàng -->
            <div class="stat-card" id="customers-card">
                <div class="loading-overlay" id="customers-loading" style="display: none;">
                    <div class="spinner"></div>
                </div>
                <img src="https://cdn-icons-png.flaticon.com/512/456/456212.png" class="stat-icon" />
                <div class="stat-title">Tổng số khách hàng</div>
                <div class="stat-value" id="total-customers">Đang tải...</div>
                <div class="stat-change blue" id="customers-change">↑ +0.00%</div>
                <a href="#" class="stat-link">Xem tất cả khách hàng</a>
                <div class="error-message" id="customers-error"></div>
            </div>

            <!-- Card 4 - Tổng số sản phẩm -->
            <div class="stat-card" id="products-card">
                <div class="loading-overlay" id="products-loading" style="display: none;">
                    <div class="spinner"></div>
                </div>
                <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" class="stat-icon" />
                <div class="stat-title">Tổng số sản phẩm</div>
                <div class="stat-value" id="total-products">Đang tải...</div>
                <div class="stat-change green" id="products-change">↑ +0.00%</div>
                <a href="#" class="stat-link">Xem tất cả sản phẩm</a>
                <div class="error-message" id="products-error"></div>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="charts grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Biểu đồ theo tuần -->
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-2xl font-bold mb-4">Biểu Đồ Doanh Thu (Theo tuần)</h2>

                <!-- Form lọc -->
                <form id="filterFormWeek" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block font-medium mb-1">Năm:</label>
                        <select id="yearSelectWeek" class="w-full border rounded p-2">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Tuần:</label>
                        <select id="weekSelect" class="w-full border rounded p-2">
                            <option value="">Tất cả các tuần</option>
                            <!-- Options sẽ được thêm bằng JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Loại thống kê:</label>
                        <select id="statTypeWeek" class="w-full border rounded p-2">
                            <option value="revenue">Doanh thu</option>
                            <option value="orders">Đơn hàng</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-3">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            Thống kê
                        </button>
                    </div>
                </form>

                <!-- Biểu đồ -->
                <div id="chart" class="h-96"></div>
            </div>

            <!-- Biểu đồ theo năm -->
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-2xl font-bold mb-4">Biểu Đồ Doanh Thu (Theo năm)</h2>

                <!-- Form lọc -->
                <form id="filterFormYear" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block font-medium mb-1">Năm:</label>
                        <select id="yearSelect" class="w-full border rounded p-2">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Loại thống kê:</label>
                        <select id="statTypeYear" class="w-full border rounded p-2">
                            <option value="revenue">Doanh thu</option>
                            <option value="orders">Đơn hàng</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            Thống kê
                        </button>
                    </div>
                </form>

                <!-- Biểu đồ -->
                <div class="line-chart-container h-96">
                    <canvas id="yearlyRevenueChart"></canvas>
                </div>
            </div>
        </div>

        <h1 style="font-size: 23px; margin-bottom: 30px;">Bảng Doanh thu</h1>
        <!-- Bộ lọc thời gian -->
        <div class="bg-white p-4 rounded-lg shadow mb-5">
            <form method="get" action="/statistics" class="flex flex-wrap items-end gap-4">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700">Ngày bắt đầu</label>
                    <input type="date" id="startDate" name="startDate" th:value="${startDate}"
                        class="mt-1 block w-48 border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700">Ngày kết thúc</label>
                    <input type="date" id="endDate" name="endDate" th:value="${endDate}"
                        class="mt-1 block w-48 border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <button type="submit"
                        class="px-5 py-2 bg-blue-600 text-white font-medium rounded-md shadow hover:bg-blue-700">
                        Lọc
                    </button>
                </div>
                <div style="margin-bottom: 10px;">
                    <a href="/statistics"
                        class="px-5 py-2 mb-10 bg-gray-300 text-gray-800 font-medium rounded-md shadow hover:bg-gray-400">
                        Xóa bộ lọc
                    </a>
                </div>
            </form>

        </div>

        <!-- Bảng thống kê đơn hàng -->
        <div class="table-container bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full table-fixed divide-y divide-gray-200">
                <thead class="bg-gray-100 sticky top-0 z-10">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[100px]">STT</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[120px]">Đơn hàng
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[140px]">Ngày tạo
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-[170px]">Người mua
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-4/12">Giá trị đơn
                            hàng</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-200 text-sm text-gray-800">
                    <tr th:each="data, iterStat : ${orderDataList}" class="hover:bg-gray-50 transition">
                        <td th:text="${iterStat.index + 1}" class="px-4 py-3 pl-6 text-left"></td>
                        <td th:text="${data.order.orderCode}"
                            class="px-4 py-3 text-left pl-0 font-medium text-blue-500 hover:underline"></td>
                        <td th:text="${#temporals.format(data.order.orderDate, 'dd/MM/yyyy')}" class="px-4 py-3 text-left"></td>
                        <td class="px-4 py-3 text-left">
                            <div th:text="${data.order.member.fullname}" class="font-medium"></div>
                            <div th:text="${data.order.member.phone}" class="text-gray-500 text-sm"></div>
                            <div th:text="${data.order.member.email}" class="text-gray-500 text-sm truncate"></div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex justify-between"><span>Giá gốc:</span><span
                                    th:text="${#numbers.formatDecimal(data.productTotal, 1, 'COMMA', 0, 'POINT') + '₫'}"></span>
                            </div>
                            <div class="flex justify-between"><span>KM:</span><span class="text-red-500"
                                    th:text="'-' + ${#numbers.formatDecimal(data.discountAmount, 1, 'COMMA', 0, 'POINT') + '₫'}"></span>
                            </div>
                            <div class="flex justify-between"><span>Giá cuối:</span><span
                                    class="text-green-600 font-semibold"
                                    th:text="${#numbers.formatDecimal(data.grandTotal, 1, 'COMMA', 0, 'POINT') + '₫'}"></span>
                            </div>
                        </td>
                    </tr>
                </tbody>

            </table>
        </div>
        <!-- Pagination -->
        <div class="flex items-center justify-between mt-4">
            <div class="text-sm text-gray-500">
                Hiển thị
                <span th:text="${(currentPage - 1) * 10 + 1}"></span> -
                <span th:text="${(currentPage - 1) * 10 + orderDataList.size()}"></span>
                của <span th:text="${totalItems}"></span> đơn hàng
            </div>

            <div class="flex space-x-2">
                <!-- Nút Previous -->
                <a th:if="${currentPage > 1}"
                    th:href="@{/statistics(page=${currentPage - 1}, size=10, startDate=${startDate}, endDate=${endDate})}"
                    class="px-3 py-1 border border-gray-300 rounded-button text-gray-500 hover:bg-gray-50 whitespace-nowrap">
                    Trước
                </a>

                <!-- Các nút trang -->
                <a th:each="i : ${#numbers.sequence(1, totalPages)}"
                    th:href="@{/statistics(page=${i}, size=10, startDate=${startDate}, endDate=${endDate})}"
                    th:text="${i}"
                    th:classappend="${i == currentPage} ? 'bg-blue-500 text-white' : 'border-gray-300 text-gray-700'"
                    class="px-3 py-1 border rounded-button whitespace-nowrap">
                </a>

                <!-- Nút Next -->
                <a th:if="${currentPage < totalPages}"
                    th:href="@{/statistics(page=${currentPage + 1}, size=10, startDate=${startDate}, endDate=${endDate})}"
                    class="px-3 py-1 border border-gray-300 rounded-button text-gray-700 hover:bg-gray-50 whitespace-nowrap">
                    Tiếp
                </a>
            </div>
        </div>

    </div>



    <script> //biểu đồ
        // Hàm lấy dữ liệu từ server
        async function fetchData(url, params = {}) {
            try {
                const queryString = new URLSearchParams(params).toString();
                const fullUrl = queryString ? `${url}?${queryString}` : url;

                const response = await fetch(fullUrl);
                return await response.json();
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu:', error);
                return [];
            }
        }

        // Biểu đồ theo năm
        const yearlyCtx = document.getElementById('yearlyRevenueChart').getContext('2d');
        let yearlyChart = null;

        // Biểu đồ theo tuần
        const chart = echarts.init(document.getElementById("chart"));

        // Hàm render biểu đồ năm
        function renderYearlyChart(data, type = "revenue") {
            if (yearlyChart) {
                yearlyChart.destroy();
            }

            const labels = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];

            const monthlyData = new Array(12).fill(0);

            data.forEach(item => {
                const month = parseInt(item.month) - 1;
                if (month >= 0 && month < 12) {
                    monthlyData[month] = type === "revenue" ?
                        (item.revenue || 0) :
                        (item.totalOrders || 0);
                }
            });

            yearlyChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: type === "revenue" ? 'Doanh thu năm' : 'Số đơn hàng',
                        data: monthlyData,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: '#10b981',
                        tension: 0.4,
                        pointRadius: 3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 13, style: 'normal' } }
                        },
                        y: { beginAtZero: true, grid: { color: '#e5e7eb' } }
                    }
                }
            });
        }

        // Hàm render biểu đồ theo các thứ trong tuần
        function renderWeeklyChart(data, type = "revenue", weekInfo = null) {
            const titleMap = {
                revenue: weekInfo ? `Doanh thu Tuần ${weekInfo.weekNumber} (${weekInfo.year})` : "Doanh thu theo tuần",
                orders: weekInfo ? `Số đơn hàng Tuần ${weekInfo.weekNumber} (${weekInfo.year})` : "Số đơn hàng theo tuần",
            };

            // Tạo mảng dữ liệu cho 7 ngày trong tuần
            const daysOfWeek = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
            const weekData = new Array(7).fill(0);

            // Điền dữ liệu vào đúng thứ
            data.forEach(item => {
                const dayIndex = parseInt(item.dayOfWeek) - 1; // SQL Server: 1=Chủ nhật, 2=Thứ 2, ..., 7=Thứ 7
                if (dayIndex >= 0 && dayIndex < 7) {
                    weekData[dayIndex] = type === "revenue" ?
                        (item.revenue || 0) :
                        (item.totalOrders || 0);
                }
            });

            console.log('Weekly chart data:', weekData);

            chart.setOption({
                title: {
                    text: titleMap[type],
                    left: "center",
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: "axis",
                    formatter: function (params) {
                        return params[0].name + '<br/>' +
                            (type === "revenue" ? "Doanh thu: " : "Số đơn hàng: ") +
                            (type === "revenue" ?
                                formatCurrency(params[0].value) :
                                params[0].value + ' đơn');
                    }
                },
                xAxis: {
                    type: "category",
                    data: daysOfWeek,
                    axisLabel: {
                        interval: 0,
                        rotate: 0
                    }
                },
                yAxis: {
                    type: "value",
                    axisLabel: {
                        formatter: type === "revenue" ?
                            function (value) {
                                if (value >= 1000000) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return (value / 1000).toFixed(0) + 'K';
                                }
                                return value;
                            } :
                            function (value) {
                                return value;
                            }
                    }
                },
                series: [{
                    name: type === "revenue" ? "Doanh thu" : "Số đơn hàng",
                    type: "bar",
                    data: weekData,
                    itemStyle: {
                        color: "#3b82f6",
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function (params) {
                            return type === "revenue" ?
                                formatCurrencyShort(params.value) :
                                params.value;
                        }
                    }
                }],
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                }
            });
        }

        // Hàm định dạng tiền tệ ngắn gọn
        function formatCurrencyShort(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(0) + 'K';
            }
            return amount;
        }

        // Hàm định dạng tiền tệ đầy đủ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm load danh sách tuần
        async function loadWeekOptions() {
            try {
                const weeksData = await fetchData('/allWeeks');
                const weekSelect = document.getElementById('weekSelect');

                // Xóa options cũ (giữ lại option "Tất cả")
                while (weekSelect.options.length > 1) {
                    weekSelect.remove(1);
                }

                // Thêm options mới
                weeksData.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.weekNumber;
                    option.textContent = `Tuần ${week.weekNumber} (${week.year})`;
                    option.dataset.year = week.year;
                    weekSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi khi tải danh sách tuần:', error);
            }
        }

        // Load dữ liệu ban đầu
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await loadWeekOptions();

                // Load dữ liệu tháng (năm hiện tại)
                const today = new Date();
                const currentYear = today.getFullYear();
                document.getElementById('yearSelectWeek').value = currentYear;
                document.getElementById('yearSelect').value = currentYear;

                const monthlyData = await fetchData('/monthlyByDate', {
                    startDate: `${currentYear}-01-01T00:00:00`,
                    endDate: `${currentYear}-12-31T23:59:59`
                });
                renderYearlyChart(monthlyData, 'revenue');

                // Load dữ liệu tuần hiện tại
                const currentWeek = getWeekNumber(today);
                document.getElementById('weekSelect').value = currentWeek;

                const dailyData = await fetchData('/dailyByWeek', {
                    year: currentYear,
                    weekNumber: currentWeek
                });
                renderWeeklyChart(dailyData, 'revenue', {
                    weekNumber: currentWeek,
                    year: currentYear
                });

            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
            }
        });

        // Hàm lấy số tuần từ ngày
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Gắn sự kiện cho form theo tuần
        document.getElementById("filterFormWeek").addEventListener("submit", async function (e) {
            e.preventDefault();
            const year = document.getElementById("yearSelectWeek").value;
            const week = document.getElementById("weekSelect").value;
            const statType = document.getElementById("statTypeWeek").value;

            if (!week) {
                alert('Vui lòng chọn tuần');
                return;
            }

            const dailyData = await fetchData('/dailyByWeek', {
                year: parseInt(year),
                weekNumber: parseInt(week)
            });
            renderWeeklyChart(dailyData, statType, {
                weekNumber: parseInt(week),
                year: parseInt(year)
            });
        });

        // Gắn sự kiện cho form theo năm
        document.getElementById("filterFormYear").addEventListener("submit", async function (e) {
            e.preventDefault();
            const year = document.getElementById("yearSelect").value;
            const statType = document.getElementById("statTypeYear").value;

            const monthlyData = await fetchData('/monthlyByDate', {
                startDate: `${year}-01-01T00:00:00`,
                endDate: `${year}-12-31T23:59:59`
            });
            renderYearlyChart(monthlyData, statType);
        });

        // Tự động chọn năm tương ứng khi chọn tuần
        document.getElementById('weekSelect').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.dataset.year) {
                document.getElementById('yearSelectWeek').value = selectedOption.dataset.year;
            }
        });
    </script>

    <script> //link card
        // Thêm sự kiện click cho các link
        document.querySelectorAll('.stat-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const cardIndex = Array.from(this.closest('.container').children).indexOf(this.closest('.stat-card'));

                switch (cardIndex) {
                    case 0: // Doanh thu
                        window.location.href = '/statistics';
                        break;
                    case 1: // Đơn hàng
                        window.location.href = '/admin-order';
                        break;
                    case 2: // Khách hàng
                        window.location.href = '/admin/users';
                        break;
                    case 3: // Sản phẩm
                        window.location.href = '/admin-products';
                        break;
                }
            });
        });

    </script>

    <script>
        // Hàm load dữ liệu thống kê dashboard
        async function loadDashboardStats() {
            try {
                showLoading(true);
                console.log('Fetching dashboard data from /dashboardd');
                const response = await fetch('/dashboardd');

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Dữ liệu nhận được từ server:', data);

                // Kiểm tra từng giá trị
                console.log('totalRevenue:', data.totalRevenue, 'type:', typeof data.totalRevenue);
                console.log('totalOrders:', data.totalOrders, 'type:', typeof data.totalOrders);
                console.log('totalCustomers:', data.totalCustomers, 'type:', typeof data.totalCustomers);
                console.log('totalProducts:', data.totalProducts, 'type:', typeof data.totalProducts);

                // Cập nhật các thẻ card với dữ liệu nhận được
                updateStatCards(data);
                showLoading(false);

            } catch (error) {
                console.error('Lỗi khi load dashboard:', error);
                document.getElementById('revenue-error').textContent = 'Không thể tải doanh thu';
                document.getElementById('orders-error').textContent = 'Không thể tải đơn hàng';
                document.getElementById('customers-error').textContent = 'Không thể tải khách hàng';
                document.getElementById('products-error').textContent = 'Không thể tải sản phẩm';
                showLoading(false);
            }
        }

        // Hiển thị/ẩn trạng thái loading
        function showLoading(show) {
            const loadingElements = [
                'revenue-loading',
                'orders-loading',
                'customers-loading',
                'products-loading'
            ];

            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = show ? 'flex' : 'none';
                }
            });
        }

        // Hàm định dạng số
        function formatNumber(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        // Hàm xử lý dữ liệu BigDecimal từ Java
        function parseBigDecimal(bigDecimal) {
            if (bigDecimal === undefined || bigDecimal === null) return 0;

            // Nếu là số thì trả về luôn
            if (typeof bigDecimal === 'number') return bigDecimal;

            // Nếu là chuỗi số
            if (typeof bigDecimal === 'string') {
                // Thử parse thành số
                const parsed = parseFloat(bigDecimal.replace(/[^\d.-]/g, ''));
                return isNaN(parsed) ? 0 : parsed;
            }

            // Xử lý object (có thể là BigDecimal từ Java)
            if (typeof bigDecimal === 'object') {
                // Kiểm tra các trường phổ biến của BigDecimal trong JSON
                if (bigDecimal.number !== undefined) {
                    return parseBigDecimal(bigDecimal.number);
                }
                if (bigDecimal.value !== undefined) {
                    return parseBigDecimal(bigDecimal.value);
                }
                if (bigDecimal.amount !== undefined) {
                    return parseBigDecimal(bigDecimal.amount);
                }

                // Xử lý intVal array nếu có (định dạng Java BigDecimal)
                if (bigDecimal.intVal !== undefined && Array.isArray(bigDecimal.intVal)) {
                    try {
                        // Chuyển mảng intVal thành chuỗi số
                        let numberStr = '';
                        for (let i = 0; i < bigDecimal.intVal.length; i++) {
                            numberStr += Math.abs(bigDecimal.intVal[i]).toString().padStart(9, '0');
                        }

                        const scale = bigDecimal.scale || 0;
                        let result;

                        if (scale > 0 && numberStr.length > scale) {
                            const integerPart = numberStr.slice(0, -scale);
                            const decimalPart = numberStr.slice(-scale);
                            result = parseFloat(integerPart + '.' + decimalPart);
                        } else {
                            result = parseInt(numberStr);
                        }

                        // Xử lý số âm
                        if (bigDecimal.intVal[0] < 0) {
                            result = -result;
                        }

                        return result;
                    } catch (e) {
                        console.error('Error parsing BigDecimal intVal:', e);
                        return 0;
                    }
                }
            }

            return 0;
        }

        // Hàm cập nhật thẻ card
        function updateStatCards(data) {
            console.log('Updating cards with data:', data);

            // Card Doanh thu
            updateCardValue(
                'total-revenue',
                'revenue-change',
                'revenue-error',
                data.totalRevenue,
                data.revenueChangePercent,
                true,
                ''
            );

            // Card Đơn hàng
            updateCardValue(
                'total-orders',
                'orders-change',
                'orders-error',
                data.totalOrders,
                data.ordersChangePercent,
                false,
                ''
            );

            // Card Khách hàng
            updateCardValue(
                'total-customers',
                'customers-change',
                'customers-error',
                data.totalCustomers,
                data.customersChangePercent,
                false,
                ''
            );

            // Card Sản phẩm
            updateCardValue(
                'total-products',
                'products-change',
                'products-error',
                data.totalProducts,
                data.productsChangePercent,
                false,
                ''
            );
        }

        // Hàm cập nhật giá trị cho từng card
        function updateCardValue(valueElementId, changeElementId, errorElementId, value, changePercent, isCurrency, suffix) {
            const valueElement = document.getElementById(valueElementId);
            const changeElement = document.getElementById(changeElementId);
            const errorElement = document.getElementById(errorElementId);

            if (!valueElement) return;

            try {
                console.log(`Updating ${valueElementId}:`, value, changePercent);

                // Xử lý giá trị
                let formattedValue = '0';
                if (value !== undefined && value !== null) {
                    let numValue;

                    // Xử lý đơn giản - chuyển đổi thành số
                    if (typeof value === 'number') {
                        numValue = value;
                    } else if (typeof value === 'string') {
                        numValue = parseFloat(value) || 0;
                    } else {
                        numValue = 0;
                    }

                    formattedValue = isCurrency ?
                        formatNumber(numValue) + suffix :
                        formatNumber(numValue);

                    errorElement.textContent = '';
                } else {
                    errorElement.textContent = 'Không có dữ liệu';
                    console.warn(`No data for ${valueElementId}`);
                }

                valueElement.textContent = formattedValue;

                // Xử lý phần trăm thay đổi
                let percentValue = 0;
                if (changePercent !== undefined && changePercent !== null) {
                    percentValue = typeof changePercent === 'number' ?
                        changePercent : parseFloat(changePercent) || 0;
                }

                const isPositive = percentValue >= 0;
                changeElement.className = `stat-change ${isPositive ? 'green' : 'red'}`;
                changeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(percentValue).toFixed(2)}%`;

            } catch (e) {
                console.error(`Error updating card ${valueElementId}:`, e);
                valueElement.textContent = isCurrency ? '0' + suffix : '0';
                errorElement.textContent = 'Lỗi dữ liệu';
            }
        }
        // Hàm định dạng số
        function formatNumber(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }
        // Gọi hàm load dashboard stats khi trang tải xong
        document.addEventListener('DOMContentLoaded', function () {
            loadDashboardStats();

            // Các hàm load dữ liệu khác...
        });
    </script>
</body>

</html>