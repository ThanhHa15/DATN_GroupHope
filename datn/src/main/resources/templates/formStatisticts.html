<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Thống kê Doanh thu</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: "#1e88e5", secondary: "#f5f5f5" },
                    borderRadius: {
                        none: "0px",
                        sm: "4px",
                        DEFAULT: "8px",
                        md: "12px",
                        lg: "16px",
                        xl: "20px",
                        "2xl": "24px",
                        "3xl": "32px",
                        full: "9999px",
                        button: "8px",
                    },
                },
            },
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: #333;
        }

        .summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 28%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #444;
        }

        .card p {
            font-size: 18px;
            color: #27ae60;
            font-weight: bold;
        }

        .charts {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        /* Tuần nhỏ hơn */
        .chart-week {
            flex: 0.8;
            height: 400px;
        }

        /* Năm to hơn */
        .chart-year {
            flex: 1.5;
            height: 400px;
        }

        .chart {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }

        .line-chart-container {
            position: relative;
            height: 100%;
        }

        .filter {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .filter label {
            font-size: 14px;
            color: #444;
        }

        .filter input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f0f0f0;
            color: #444;
        }

        tr:hover {
            background: #fafafa;
        }
    </style>
    <style>
        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        body {
            background-color: #f0f3f7;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: #2c3e50;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }



        .stats-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            flex: 1;
            min-width: 240px;
            text-decoration: none;
            position: relative;
        }

        .stat-card::before {
            content: "";
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #eaf6f2;
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }

        .stat-icon {
            width: 24px;
            height: 24px;
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }

        .stat-title {
            font-size: 14px;
            color: #666;
            margin-top: 30px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 5px 0;
        }

        .stat-change {
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }

        .stat-link {
            text-align: center;
            display: block;
            font-size: 14px;
            text-decoration: underline;
            color: #000;
        }

        .green {
            color: #16c784;
        }

        .red {
            color: #ef4444;
        }

        .blue {
            color: #3b82f6;
        }

        .yellow {
            color: #090909;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
        }
    </style>

</head>

<body>
    <div th:replace="nav :: na"></div>
    <div th:replace="header :: header"></div>

    <div style="margin-left: 300px; margin-top: 70px;">
        <h1 style="font-size: 23px; margin-bottom: 30px;">Thống kê Doanh thu</h1>

        <div class="container" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px">
            <!-- Card 1 - Tổng doanh thu -->
            <div class="stat-card" id="revenue-card">
                <img src="https://cdn-icons-png.flaticon.com/512/263/263115.png" class="stat-icon" />
                <div class="stat-title">Tổng doanh thu</div>
                <div class="stat-value">
                    <span id="total-revenue">Đang tải...</span><span class="underline">đ</span>
                </div>
                <div class="stat-change green" id="revenue-change">↑ +0.00%</div>
                <a href="#" class="stat-link">Xem tất cả doanh thu</a>
                <div class="error-message" id="revenue-error"></div>
            </div>

            <!-- Card 2 -->
            <div class="stat-card">
                <img src="https://cdn-icons-png.flaticon.com/512/1040/1040230.png" class="stat-icon" />
                <div class="stat-title">Tổng đơn hàng</div>
                <div class="stat-value">5</div>
                <div class="stat-change red">↓ -80.00%</div>
                <a href="#" class="stat-link">Xem tất cả đơn hàng</a>
            </div>

            <!-- Card 3 -->
            <div class="stat-card">
                <img src="https://cdn-icons-png.flaticon.com/512/456/456212.png" class="stat-icon" />
                <div class="stat-title">Tổng số khách hàng</div>
                <div class="stat-value">15</div>
                <div class="stat-change blue">↑ +80.00%</div>
                <a href="#" class="stat-link">Xem tất cả khách hàng</a>
            </div>

            <!-- Card 4 -->
            <div class="stat-card">
                <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" class="stat-icon" />
                <div class="stat-title">Tổng số sản phẩm</div>
                <div class="stat-value">20</div>
                <div class="stat-change green">↑ +80.00%</div>
                <a href="#" class="stat-link">Xem tất cả sản phẩm</a>
            </div>
        </div>

        <!-- Biểu đồ -->
        <div class="charts grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Biểu đồ theo tuần -->
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-2xl font-bold mb-4">Biểu Đồ Doanh Thu (Theo tuần)</h2>

                <!-- Form lọc -->
                <form id="filterFormWeek" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block font-medium mb-1">Năm:</label>
                        <select id="yearSelectWeek" class="w-full border rounded p-2">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Tuần:</label>
                        <select id="weekSelect" class="w-full border rounded p-2">
                            <option value="">Tất cả các tuần</option>
                            <!-- Options sẽ được thêm bằng JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Loại thống kê:</label>
                        <select id="statTypeWeek" class="w-full border rounded p-2">
                            <option value="revenue">Doanh thu</option>
                            <option value="orders">Đơn hàng</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-3">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            Thống kê
                        </button>
                    </div>
                </form>

                <!-- Biểu đồ -->
                <div id="chart" class="h-96"></div>
            </div>

            <!-- Biểu đồ theo năm -->
            <div class="bg-white p-6 rounded shadow">
                <h2 class="text-2xl font-bold mb-4">Biểu Đồ Doanh Thu (Theo năm)</h2>

                <!-- Form lọc -->
                <form id="filterFormYear" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block font-medium mb-1">Năm:</label>
                        <select id="yearSelect" class="w-full border rounded p-2">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1">Loại thống kê:</label>
                        <select id="statTypeYear" class="w-full border rounded p-2">
                            <option value="revenue">Doanh thu</option>
                            <option value="orders">Đơn hàng</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            Thống kê
                        </button>
                    </div>
                </form>

                <!-- Biểu đồ -->
                <div class="line-chart-container h-96">
                    <canvas id="yearlyRevenueChart"></canvas>
                </div>
            </div>
        </div>


        <!-- Bảng dữ liệu -->
        <table>
            <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Khách hàng</th>
                    <th>Ngày</th>
                    <th>Tổng tiền</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>#DH001</td>
                    <td>Nguyễn Văn A</td>
                    <td>01/08/2025</td>
                    <td>5.500.000 ₫</td>
                    <td>Đã giao</td>
                </tr>
                <tr>
                    <td>#DH002</td>
                    <td>Trần Thị B</td>
                    <td>01/08/2025</td>
                    <td>12.000.000 ₫</td>
                    <td>Đang xử lý</td>
                </tr>
                <tr>
                    <td>#DH003</td>
                    <td>Lê Văn C</td>
                    <td>31/07/2025</td>
                    <td>7.200.000 ₫</td>
                    <td>Đã hủy</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script> //biểu đồ
        // Hàm lấy dữ liệu từ server
        async function fetchData(url, params = {}) {
            try {
                const queryString = new URLSearchParams(params).toString();
                const fullUrl = queryString ? `${url}?${queryString}` : url;

                const response = await fetch(fullUrl);
                return await response.json();
            } catch (error) {
                console.error('Lỗi khi lấy dữ liệu:', error);
                return [];
            }
        }

        // Biểu đồ theo năm
        const yearlyCtx = document.getElementById('yearlyRevenueChart').getContext('2d');
        let yearlyChart = null;

        // Biểu đồ theo tuần
        const chart = echarts.init(document.getElementById("chart"));

        // Hàm render biểu đồ năm
        function renderYearlyChart(data, type = "revenue") {
            if (yearlyChart) {
                yearlyChart.destroy();
            }

            const labels = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];

            const monthlyData = new Array(12).fill(0);

            data.forEach(item => {
                const month = parseInt(item.month) - 1;
                if (month >= 0 && month < 12) {
                    monthlyData[month] = type === "revenue" ?
                        (item.revenue || 0) :
                        (item.totalOrders || 0);
                }
            });

            yearlyChart = new Chart(yearlyCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: type === "revenue" ? 'Doanh thu năm' : 'Số đơn hàng',
                        data: monthlyData,
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: '#10b981',
                        tension: 0.4,
                        pointRadius: 3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 13, style: 'normal' } }
                        },
                        y: { beginAtZero: true, grid: { color: '#e5e7eb' } }
                    }
                }
            });
        }

        // Hàm render biểu đồ theo các thứ trong tuần
        function renderWeeklyChart(data, type = "revenue", weekInfo = null) {
            const titleMap = {
                revenue: weekInfo ? `Doanh thu Tuần ${weekInfo.weekNumber} (${weekInfo.year})` : "Doanh thu theo tuần",
                orders: weekInfo ? `Số đơn hàng Tuần ${weekInfo.weekNumber} (${weekInfo.year})` : "Số đơn hàng theo tuần",
            };

            // Tạo mảng dữ liệu cho 7 ngày trong tuần
            const daysOfWeek = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
            const weekData = new Array(7).fill(0);

            // Điền dữ liệu vào đúng thứ
            data.forEach(item => {
                const dayIndex = parseInt(item.dayOfWeek) - 1; // SQL Server: 1=Chủ nhật, 2=Thứ 2, ..., 7=Thứ 7
                if (dayIndex >= 0 && dayIndex < 7) {
                    weekData[dayIndex] = type === "revenue" ?
                        (item.revenue || 0) :
                        (item.totalOrders || 0);
                }
            });

            console.log('Weekly chart data:', weekData);

            chart.setOption({
                title: {
                    text: titleMap[type],
                    left: "center",
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: "axis",
                    formatter: function (params) {
                        return params[0].name + '<br/>' +
                            (type === "revenue" ? "Doanh thu: " : "Số đơn hàng: ") +
                            (type === "revenue" ?
                                formatCurrency(params[0].value) :
                                params[0].value + ' đơn');
                    }
                },
                xAxis: {
                    type: "category",
                    data: daysOfWeek,
                    axisLabel: {
                        interval: 0,
                        rotate: 0
                    }
                },
                yAxis: {
                    type: "value",
                    axisLabel: {
                        formatter: type === "revenue" ?
                            function (value) {
                                if (value >= 1000000) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return (value / 1000).toFixed(0) + 'K';
                                }
                                return value;
                            } :
                            function (value) {
                                return value;
                            }
                    }
                },
                series: [{
                    name: type === "revenue" ? "Doanh thu" : "Số đơn hàng",
                    type: "bar",
                    data: weekData,
                    itemStyle: {
                        color: "#3b82f6",
                        borderRadius: [4, 4, 0, 0]
                    },
                    label: {
                        show: true,
                        position: 'top',
                        formatter: function (params) {
                            return type === "revenue" ?
                                formatCurrencyShort(params.value) :
                                params.value;
                        }
                    }
                }],
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                }
            });
        }

        // Hàm định dạng tiền tệ ngắn gọn
        function formatCurrencyShort(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(0) + 'K';
            }
            return amount;
        }

        // Hàm định dạng tiền tệ đầy đủ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm load danh sách tuần
        async function loadWeekOptions() {
            try {
                const weeksData = await fetchData('/allWeeks');
                const weekSelect = document.getElementById('weekSelect');

                // Xóa options cũ (giữ lại option "Tất cả")
                while (weekSelect.options.length > 1) {
                    weekSelect.remove(1);
                }

                // Thêm options mới
                weeksData.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.weekNumber;
                    option.textContent = `Tuần ${week.weekNumber} (${week.year})`;
                    option.dataset.year = week.year;
                    weekSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi khi tải danh sách tuần:', error);
            }
        }

        // Load dữ liệu ban đầu
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await loadWeekOptions();

                // Load dữ liệu tháng (năm hiện tại)
                const today = new Date();
                const currentYear = today.getFullYear();
                document.getElementById('yearSelectWeek').value = currentYear;
                document.getElementById('yearSelect').value = currentYear;

                const monthlyData = await fetchData('/monthlyByDate', {
                    startDate: `${currentYear}-01-01T00:00:00`,
                    endDate: `${currentYear}-12-31T23:59:59`
                });
                renderYearlyChart(monthlyData, 'revenue');

                // Load dữ liệu tuần hiện tại
                const currentWeek = getWeekNumber(today);
                document.getElementById('weekSelect').value = currentWeek;

                const dailyData = await fetchData('/dailyByWeek', {
                    year: currentYear,
                    weekNumber: currentWeek
                });
                renderWeeklyChart(dailyData, 'revenue', {
                    weekNumber: currentWeek,
                    year: currentYear
                });

            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
            }
        });

        // Hàm lấy số tuần từ ngày
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Gắn sự kiện cho form theo tuần
        document.getElementById("filterFormWeek").addEventListener("submit", async function (e) {
            e.preventDefault();
            const year = document.getElementById("yearSelectWeek").value;
            const week = document.getElementById("weekSelect").value;
            const statType = document.getElementById("statTypeWeek").value;

            if (!week) {
                alert('Vui lòng chọn tuần');
                return;
            }

            const dailyData = await fetchData('/dailyByWeek', {
                year: parseInt(year),
                weekNumber: parseInt(week)
            });
            renderWeeklyChart(dailyData, statType, {
                weekNumber: parseInt(week),
                year: parseInt(year)
            });
        });

        // Gắn sự kiện cho form theo năm
        document.getElementById("filterFormYear").addEventListener("submit", async function (e) {
            e.preventDefault();
            const year = document.getElementById("yearSelect").value;
            const statType = document.getElementById("statTypeYear").value;

            const monthlyData = await fetchData('/monthlyByDate', {
                startDate: `${year}-01-01T00:00:00`,
                endDate: `${year}-12-31T23:59:59`
            });
            renderYearlyChart(monthlyData, statType);
        });

        // Tự động chọn năm tương ứng khi chọn tuần
        document.getElementById('weekSelect').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.dataset.year) {
                document.getElementById('yearSelectWeek').value = selectedOption.dataset.year;
            }
        });
    </script>

    <script> // Thống kê dashboard
        // Hàm định dạng số tiền
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm định dạng số
        function formatNumber(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        // Hàm cập nhật thẻ card
        function updateStatCards(data) {
            // Card Doanh thu
            const revenueElement = document.querySelector('.stat-card:nth-child(1) .stat-value');
            const revenueChangeElement = document.querySelector('.stat-card:nth-child(1) .stat-change');

            if (revenueElement && data.totalRevenue !== undefined) {
                revenueElement.innerHTML = `${formatNumber(data.totalRevenue)}<span class="underline">đ</span>`;

                if (data.revenueChangePercent !== undefined) {
                    const changePercent = parseFloat(data.revenueChangePercent);
                    const isPositive = changePercent >= 0;
                    revenueChangeElement.className = `stat-change ${isPositive ? 'green' : 'red'}`;
                    revenueChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(changePercent).toFixed(2)}%`;
                }
            }

            // Card Đơn hàng
            const ordersElement = document.querySelector('.stat-card:nth-child(2) .stat-value');
            const ordersChangeElement = document.querySelector('.stat-card:nth-child(2) .stat-change');

            if (ordersElement && data.totalOrders !== undefined) {
                ordersElement.textContent = formatNumber(data.totalOrders);

                if (data.ordersChangePercent !== undefined) {
                    const changePercent = parseFloat(data.ordersChangePercent);
                    const isPositive = changePercent >= 0;
                    ordersChangeElement.className = `stat-change ${isPositive ? 'green' : 'red'}`;
                    ordersChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(changePercent).toFixed(2)}%`;
                }
            }

            // Card Khách hàng
            const customersElement = document.querySelector('.stat-card:nth-child(3) .stat-value');
            const customersChangeElement = document.querySelector('.stat-card:nth-child(3) .stat-change');

            if (customersElement && data.totalCustomers !== undefined) {
                customersElement.textContent = formatNumber(data.totalCustomers);

                if (data.customersChangePercent !== undefined) {
                    const changePercent = parseFloat(data.customersChangePercent);
                    const isPositive = changePercent >= 0;
                    customersChangeElement.className = `stat-change ${isPositive ? 'blue' : 'red'}`;
                    customersChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(changePercent).toFixed(2)}%`;
                }
            }

            // Card Sản phẩm
            const productsElement = document.querySelector('.stat-card:nth-child(4) .stat-value');
            const productsChangeElement = document.querySelector('.stat-card:nth-child(4) .stat-change');

            if (productsElement && data.totalProducts !== undefined) {
                productsElement.textContent = formatNumber(data.totalProducts);

                // Luôn hiển thị 0% hoặc có thể ẩn phần trăm thay đổi
                productsChangeElement.className = 'stat-change blue';
                productsChangeElement.innerHTML = '→ 0%';

                // Hoặc nếu muốn ẩn hoàn toàn:
                // productsChangeElement.style.display = 'none';
            }
        }

        // Hàm load dữ liệu thống kê dashboard
        async function loadDashboardStats() {
            try {
                const response = await fetch('/dashboardStats');
                const data = await response.json();
                console.log('Dashboard stats:', data);
                updateStatCards(data);
            } catch (error) {
                console.error('Lỗi khi tải thống kê dashboard:', error);
            }
        }

        // Load dữ liệu ban đầu
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Load thống kê dashboard
                await loadDashboardStats();

                // Các phần code khác...
                await loadWeekOptions();

                // Load dữ liệu tháng (năm hiện tại)
                const today = new Date();
                const currentYear = today.getFullYear();
                document.getElementById('yearSelectWeek').value = currentYear;
                document.getElementById('yearSelect').value = currentYear;

                const monthlyData = await fetchData('/monthlyByDate', {
                    startDate: `${currentYear}-01-01T00:00:00`,
                    endDate: `${currentYear}-12-31T23:59:59`
                });
                renderYearlyChart(monthlyData, 'revenue');

                // Load dữ liệu tuần hiện tại
                const currentWeek = getWeekNumber(today);
                document.getElementById('weekSelect').value = currentWeek;

                const dailyData = await fetchData('/dailyByWeek', {
                    year: currentYear,
                    weekNumber: currentWeek
                });
                renderWeeklyChart(dailyData, 'revenue', {
                    weekNumber: currentWeek,
                    year: currentYear
                });

            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
            }
        });
    </script>

    <script> //link card
        // Thêm sự kiện click cho các link
        document.querySelectorAll('.stat-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const cardIndex = Array.from(this.closest('.container').children).indexOf(this.closest('.stat-card'));

                switch (cardIndex) {
                    case 0: // Doanh thu
                        window.location.href = '/statistics';
                        break;
                    case 1: // Đơn hàng
                        window.location.href = '/admin-order';
                        break;
                    case 2: // Khách hàng
                        window.location.href = '/admin/users';
                        break;
                    case 3: // Sản phẩm
                        window.location.href = '/admin-products';
                        break;
                }
            });
        });

    </script>

    <script> // Hàm cập nhật thẻ card
        // Hàm định dạng số tiền
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Hàm định dạng số
        function formatNumber(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        // Hàm xử lý dữ liệu BigDecimal từ Java
        function parseBigDecimal(bigDecimal) {
            if (!bigDecimal) return 0;

            // Nếu là số thông thường
            if (typeof bigDecimal === 'number') {
                return bigDecimal;
            }

            // Nếu là chuỗi
            if (typeof bigDecimal === 'string') {
                return parseFloat(bigDecimal.replace(/,/g, '')) || 0;
            }

            // Nếu là object (BigDecimal từ Java)
            if (typeof bigDecimal === 'object') {
                // Kiểm tra định dạng BigDecimal phổ biến
                if (bigDecimal.intVal !== undefined && Array.isArray(bigDecimal.intVal)) {
                    // Xử lý mảng intVal - chuyển đổi thành số
                    let numberStr = '';
                    for (let i = 0; i < bigDecimal.intVal.length; i++) {
                        numberStr += bigDecimal.intVal[i].toString();
                    }

                    // Áp dụng scale (số chữ số thập phân)
                    const scale = bigDecimal.scale || 0;
                    if (scale > 0 && numberStr.length > scale) {
                        const integerPart = numberStr.slice(0, -scale);
                        const decimalPart = numberStr.slice(-scale);
                        return parseFloat(integerPart + '.' + decimalPart);
                    } else {
                        return parseFloat(numberStr);
                    }
                } else if (bigDecimal.value !== undefined) {
                    // Nếu có trường value
                    return typeof bigDecimal.value === 'string' ?
                        parseFloat(bigDecimal.value) : bigDecimal.value;
                }
            }

            return 0;
        }


        // Hàm cập nhật thẻ card
        function updateStatCards(data) {
            console.log('Updating cards with data:', data);

            // Card Doanh thu
            const revenueElement = document.getElementById('total-revenue');
            const revenueChangeElement = document.getElementById('revenue-change');
            const revenueErrorElement = document.getElementById('revenue-error');
            
            if (revenueElement) {
                let revenueValue = 0;
                
                // Xử lý dữ liệu doanh thu
                if (data.totalRevenue !== undefined && data.totalRevenue !== null) {
                    revenueValue = parseBigDecimal(data.totalRevenue);
                    revenueElement.textContent = formatNumber(revenueValue);
                    revenueErrorElement.textContent = '';
                } else {
                    revenueElement.textContent = '0';
                    revenueErrorElement.textContent = 'Không có dữ liệu doanh thu';
                }
                
                // Xử lý phần trăm thay đổi
                let changePercent = 0;
                if (data.revenueChangePercent !== undefined && data.revenueChangePercent !== null) {
                    changePercent = typeof data.revenueChangePercent === 'number' ? 
                                   data.revenueChangePercent : parseFloat(data.revenueChangePercent) || 0;
                }
                
                const isPositive = changePercent >= 0;
                revenueChangeElement.className = `stat-change ${isPositive ? 'green' : 'red'}`;
                revenueChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(changePercent).toFixed(2)}%`;
            }

            // Card Đơn hàng
            const ordersElement = document.querySelector('.stat-card:nth-child(2) .stat-value');
            const ordersChangeElement = document.querySelector('.stat-card:nth-child(2) .stat-change');

            if (ordersElement && data.totalOrders !== undefined) {
                ordersElement.textContent = formatNumber(data.totalOrders);

                let ordersChangePercent = 0;
                if (data.ordersChangePercent !== undefined && data.ordersChangePercent !== null) {
                    ordersChangePercent = typeof data.ordersChangePercent === 'number' ?
                        data.ordersChangePercent : parseFloat(data.ordersChangePercent) || 0;
                }

                const isPositive = ordersChangePercent >= 0;
                ordersChangeElement.className = `stat-change ${isPositive ? 'green' : 'red'}`;
                ordersChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(ordersChangePercent).toFixed(2)}%`;
            }

            // Card Khách hàng
            const customersElement = document.querySelector('.stat-card:nth-child(3) .stat-value');
            const customersChangeElement = document.querySelector('.stat-card:nth-child(3) .stat-change');

            if (customersElement && data.totalCustomers !== undefined) {
                customersElement.textContent = formatNumber(data.totalCustomers);

                let customersChangePercent = 0;
                if (data.customersChangePercent !== undefined && data.customersChangePercent !== null) {
                    customersChangePercent = typeof data.customersChangePercent === 'number' ?
                        data.customersChangePercent : parseFloat(data.customersChangePercent) || 0;
                }

                const isPositive = customersChangePercent >= 0;
                customersChangeElement.className = `stat-change ${isPositive ? 'blue' : 'red'}`;
                customersChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(customersChangePercent).toFixed(2)}%`;
            }

            // Card Sản phẩm
            const productsElement = document.querySelector('.stat-card:nth-child(4) .stat-value');
            const productsChangeElement = document.querySelector('.stat-card:nth-child(4) .stat-change');

            if (productsElement && data.totalProducts !== undefined) {
                productsElement.textContent = formatNumber(data.totalProducts);

                let productsChangePercent = 0;
                if (data.productsChangePercent !== undefined && data.productsChangePercent !== null) {
                    productsChangePercent = typeof data.productsChangePercent === 'number' ?
                        data.productsChangePercent : parseFloat(data.productsChangePercent) || 0;
                }

                const isPositive = productsChangePercent >= 0;
                productsChangeElement.className = `stat-change ${isPositive ? 'green' : 'red'}`;
                productsChangeElement.innerHTML = `${isPositive ? '↑' : '↓'} ${Math.abs(productsChangePercent).toFixed(2)}%`;
            }
        }

        // Hàm convert BigInteger array to number (nếu cần)
        function parseBigInteger(intVal, scale) {
            if (!intVal || !Array.isArray(intVal)) return 0;

            // Nếu là mảng [103933000] - đơn giản
            if (intVal.length === 1 && typeof intVal[0] === 'number') {
                return intVal[0] / Math.pow(10, scale || 0);
            }

            return 0; // Fallback
        }
    </script>
</body>

</html>